仿牛客社区项目

##  项目概览

项目地址：https://github.com/xiaoyivip/community

### 核心功能：

- 发帖、评论、私信、转发；
- 点赞、关注、通知、搜索；
- 权限、统计、调度、监控；

### 核心技术：

- Spring Boot、SSM
- Redis、Kafka、ElasticSearch
- Spring Security、Quatz、Caffeine

### 项目亮点：

- 项目构建在Spring Boot+SSM框架之上，并统一的进行了状态管理、事务管理、异常处理；
- 利用Redis实现了点赞和关注功能，单机可达5000TPS；
- 利用Kafka实现了异步的站内通知，单机可达7000TPS；
- 利用ElasticSearch实现了全文搜索功能，可准确匹配搜索结果，并高亮显示关键词；
- 利用Caffeine+Redis实现了两级缓存，并优化了热门帖子的访问，单机可达8000QPS。
- 利用Spring Security实现了权限控制，实现了多重角色、URL级别的权限管理；
- 利用HyperLogLog、Bitmap分别实现了UV、DAU的统计功能，100万用户数据只需*M内存空间；
- 利用Quartz实现了任务调度功能，并实现了定时计算帖子分数、定时清理垃圾文件等功能；
- 利用Actuator对应用的Bean、缓存、日志、路径等多个维度进行了监控，并通过自定义的端点对数据库连接进行了监控。

****

##  基本环境配置

> 记录学习和开发牛客社区项目过程中遇到的问题和流程。

### 使用maven

- maven的安装配置

> 略

- maven的基本命令

> 1.查看版本信息

```java
mvn -version
```

> 2.创建maven项目

```java
mvn archetype:generate -DgroupId=com.mycompany.app -DartifactId=my-app -DarchetypeArtifactId=maven-archetype-quickstart -DarchetypeVersion=1.4 -DinteractiveMode=false
```

> 注意重点修改 ```DgroupId``` ``` DartifactId``` 即可

> 创建成功效果：

![image-20211120153619773](https://i.loli.net/2021/11/20/wsf6aSXjNEL3mRG.png)

> 3.编译项目

> 需要先切换到需要编译的项目目录【含有pom.xml】的文件目录下执行以下命令：```mvn compile```

> 编译效果：

![image-20211120154153309](https://i.loli.net/2021/11/20/vfX4rg9KNskVSiW.png)

> 成功编译之后会再对应目录下生成target目录



> 4.清理

> 执行```mvn clean```可以清除上一次的编译。

![image-20211120154421651](https://i.loli.net/2021/11/20/1F9cOv3JGqEufer.png)

> 当然也可以将编译和清理命令混合使用：```mvn clean compile``` 效果是一样的。



>5.跑测试

> 如果需要运行test文件，可以参考下面的命令:```mvn clean test```

![image-20211120154829713](https://i.loli.net/2021/11/20/Nd8KXJQPj9Vh6zk.png)



###  使用/配置IDEA

> 由于之前已经配置完毕，暂略..



#### 使用Spring Initializr

- 链接： [Spring Initializr](https://start.spring.io/)

![image-20211120161730721](https://i.loli.net/2021/11/20/V9RfJMkAKaQhzFX.png)

> 相关的使用说明见上图。

![image-20211120161826608](https://i.loli.net/2021/11/20/AWHqcxZw812hDFy.png)

> 配置完毕之后点这里下载项目

> 下载解压之后大概是这样的。
>
> ![image-20211120162237224](https://i.loli.net/2021/11/20/iv3n1kGhJCVflY9.png)

![image-20211120163310830](https://i.loli.net/2021/11/20/cIaUpdyz9SXRxBZ.png)

> 刚才下载的项目导入和一般的JavaWeb项目导入方式是一样的，就不再赘述。



###  项目开始

- 修改tomcat服务端口

> 如下图：

![image-20211120165157448](https://i.loli.net/2021/11/20/uzYnBTwHegImkrU.png)

#### 数据库相关

- 导入数据库文件

> 命令行操作：source 文件路径/sql文件

![image-20211121154449921](https://i.loli.net/2021/11/21/qhFEtzXkAN1CD3Q.png)

#### 调试技巧

- 服务端idea的debug调试:
- 执行下一行代码

> F8

- 进入该行所调用的方法

> F7

- 如果想直接执行到结束或者下一个断点的位置(比如跳过循环)

> F9

------------



## 开发社区首页

> 开发社区首页，包括帖子数据的的展示和分页。

### 后端

#### 配置文件

##### pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>2.6.0</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
	<groupId>com.nowcoder.community</groupId>
	<artifactId>community</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>community</name>
	<description>nowcoder community!</description>
	<properties>
		<java.version>11</java.version>
	</properties>

	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-aop</artifactId>
		</dependency>
<!--		<dependency>-->
<!--			<groupId>org.springframework.boot</groupId>-->
<!--			<artifactId>spring-boot-starter-thymeleaf</artifactId>-->
<!--		</dependency>-->
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-thymeleaf</artifactId>
			<version>2.5.1</version>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-devtools</artifactId>
			<scope>runtime</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>

		<dependency>
			<groupId>mysql</groupId>
			<artifactId>mysql-connector-java</artifactId>
			<version>8.0.16</version>
		</dependency>

		<!--字符串判空-->
		<dependency>
			<groupId>org.apache.commons</groupId>
			<artifactId>commons-lang3</artifactId>
			<version>3.9</version>
		</dependency>


		<dependency>
			<groupId>org.mybatis.spring.boot</groupId>
			<artifactId>mybatis-spring-boot-starter</artifactId>
			<version>2.0.1</version>
		</dependency>
		<dependency>
			<groupId>junit</groupId>
			<artifactId>junit</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>org.projectlombok</groupId>
			<artifactId>lombok</artifactId>
		</dependency>

	</dependencies>
	<build>
		<plugins>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
				<configuration>
					<excludes>
						<exclude>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</exclude>
					</excludes>
				</configuration>
			</plugin>
		</plugins>
	</build>

</project>

```

##### applocation.xml

```xml
# ServerProperties
server.port=8080
server.servlet.context-path=/community
# ThymeleafProperties
spring.thymeleaf.cache=false

# DataSourceProperties
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.url=jdbc:mysql://localhost:3306/community?characterEncoding=utf-8&useSSL=false&serverTimezone=Hongkong
spring.datasource.username=root
spring.datasource.password=123456
spring.datasource.type=com.zaxxer.hikari.HikariDataSource
spring.datasource.hikari.maximum-pool-size=15
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.idle-timeout=30000

# MybatisProperties
mybatis.mapper-locations=classpath:mapper/*.xml
mybatis.type-aliases-package=com.nowcoder.community.entity
mybatis.configuration.useGeneratedKeys=true
mybatis.configuration.mapUnderscoreToCamelCase=true

# logger 级别
logging.level.com.nowcoder.community = debug

# 打印日志到文件夹
#logging.file.path=E:/nowcoder/log/community/community.log
```

> 相关的说明已经注释。

#### 日志文件：logback-spring.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <contextName>community</contextName>
    <!--日志的存放路径-->
    <property name="LOG_PATH" value="E:/nowcoder/log/community"/>
    <!--日志包名-->
    <property name="APPDIR" value="community"/>

    <!-- error file -->
    <appender name="FILE_ERROR" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${APPDIR}/log_error.log</file>
        <!--日志存放策略：当满5M就创建一个新额定日志文件夹进行存储-->
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/${APPDIR}/error/log-error-%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>5MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <!--30天有效期：过期清理-->
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <!--以追加的方式存放日志-->
        <append>true</append>
        <!--日志格式-->
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>%d %level [%thread] %logger{10} [%file:%line] %msg%n</pattern>
            <charset>utf-8</charset>
        </encoder>
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>error</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
    </appender>

    <!-- warn file -->
    <appender name="FILE_WARN" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${APPDIR}/log_warn.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/${APPDIR}/warn/log-warn-%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>5MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <append>true</append>
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>%d %level [%thread] %logger{10} [%file:%line] %msg%n</pattern>
            <charset>utf-8</charset>
        </encoder>
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>warn</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
    </appender>

    <!-- info file -->
    <appender name="FILE_INFO" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${APPDIR}/log_info.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/${APPDIR}/info/log-info-%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>5MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <append>true</append>
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>%d %level [%thread] %logger{10} [%file:%line] %msg%n</pattern>
            <charset>utf-8</charset>
        </encoder>
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>info</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
    </appender>

    <!-- console -->
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d %level [%thread] %logger{10} [%file:%line] %msg%n</pattern>
            <charset>utf-8</charset>
        </encoder>
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
            <level>debug</level>
        </filter>
    </appender>

    <logger name="com.nowcoder.community" level="debug"/>

    <root level="info">
        <appender-ref ref="FILE_ERROR"/>
        <appender-ref ref="FILE_WARN"/>
        <appender-ref ref="FILE_INFO"/>
        <appender-ref ref="STDOUT"/>
    </root>

</configuration>
```

> 由于在实际的项目中，一旦发布到服务器，本地的控制台日志也就没什么实际意义了，所以一般需要将项目运行产生的日志输出到指定的文件夹中，以方便随时查看。

#### 实体类：DiscussPost

```java
package com.nowcoder.community.entity;

import java.util.Date;

/**
 * @author: XuYi
 * @date: 2021/11/21 17:48
 * @description:
 */
public class DiscussPost {
    private int id;
    private int userId;
    private String title;
    private String content;
    private int type;
    private int status;
    private Date createTime;
    private int commentCount;
    private double score;

    public DiscussPost() {

    }

    @Override
    public String toString() {
        return "DiscussPost{" +
                "id=" + id +
                ", userId=" + userId +
                ", title='" + title + '\'' +
                ", content='" + content + '\'' +
                ", type=" + type +
                ", status=" + status +
                ", createTime=" + createTime +
                ", commentCount=" + commentCount +
                ", score=" + score +
                '}';
    }

    public DiscussPost(int id, int userId, String title, String content, int type, int status, Date createTime, int commentCount, double score) {
        this.id = id;
        this.userId = userId;
        this.title = title;
        this.content = content;
        this.type = type;
        this.status = status;
        this.createTime = createTime;
        this.commentCount = commentCount;
        this.score = score;
    }

    public int getId() {
        return id;
    }

    public void setId(int id) {
        this.id = id;
    }

    public int getUserId() {
        return userId;
    }

    public void setUserId(int userId) {
        this.userId = userId;
    }

    public String getTitle() {
        return title;
    }

    public void setTitle(String title) {
        this.title = title;
    }

    public String getContent() {
        return content;
    }

    public void setContent(String content) {
        this.content = content;
    }

    public int getType() {
        return type;
    }

    public void setType(int type) {
        this.type = type;
    }

    public int getStatus() {
        return status;
    }

    public void setStatus(int status) {
        this.status = status;
    }

    public Date getCreateTime() {
        return createTime;
    }

    public void setCreateTime(Date createTime) {
        this.createTime = createTime;
    }

    public int getCommentCount() {
        return commentCount;
    }

    public void setCommentCount(int commentCount) {
        this.commentCount = commentCount;
    }

    public double getScore() {
        return score;
    }

    public void setScore(double score) {
        this.score = score;
    }
}
```

#### 实体类：User

```java
package com.nowcoder.community.entity;

import java.util.Date;

/**
 * @author: XuYi
 * @date: 2021/11/21 16:23
 * @description:
 */
public class User {
    private int id;
    private String username;
    private String password;
    private String salt;
    private String email;
    private int type;
    private int status;
    private String activationCode;
    private String headerUrl;
    private Date createTime;

    public User() {
    }

    @Override
    public String toString() {
        return "User{" +
                "id=" + id +
                ", username='" + username + '\'' +
                ", password='" + password + '\'' +
                ", salt='" + salt + '\'' +
                ", email='" + email + '\'' +
                ", type=" + type +
                ", status=" + status +
                ", activationCode='" + activationCode + '\'' +
                ", headerUrl='" + headerUrl + '\'' +
                ", createTime=" + createTime +
                '}';
    }

    public int getId() {
        return id;
    }

    public void setId(int id) {
        this.id = id;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    public String getSalt() {
        return salt;
    }

    public void setSalt(String salt) {
        this.salt = salt;
    }

    public String getEmail() {
        return email;
    }

    public void setEmail(String email) {
        this.email = email;
    }

    public int getType() {
        return type;
    }

    public void setType(int type) {
        this.type = type;
    }

    public int getStatus() {
        return status;
    }

    public void setStatus(int status) {
        this.status = status;
    }

    public String getActivationCode() {
        return activationCode;
    }

    public void setActivationCode(String activationCode) {
        this.activationCode = activationCode;
    }

    public String getHeaderUrl() {
        return headerUrl;
    }

    public void setHeaderUrl(String headerUrl) {
        this.headerUrl = headerUrl;
    }

    public Date getCreateTime() {
        return createTime;
    }

    public void setCreateTime(Date createTime) {
        this.createTime = createTime;
    }

    public User(int id, String username, String password, String salt, String email, int type, int status, String activationCode, String headerUrl, Date createTime) {
        this.id = id;
        this.username = username;
        this.password = password;
        this.salt = salt;
        this.email = email;
        this.type = type;
        this.status = status;
        this.activationCode = activationCode;
        this.headerUrl = headerUrl;
        this.createTime = createTime;
    }
}
```

#### 实体类：Page

> 处理帖子信息数据的分页。

```java
package com.nowcoder.community.entity;

/**
 * 封装分页相关的信息.
 */
public class Page {

    // 当前页码
    private int current = 1;
    // 显示上限
    private int limit = 10;
    // 数据总数(用于计算总页数)
    private int rows;
    // 查询路径(用于复用分页链接)
    private String path;

    public int getCurrent() {
        return current;
    }
	/*需要满足特定条件才可以执行set*/
    public void setCurrent(int current) {
        if (current >= 1) {
            this.current = current;
        }
    }

    public int getLimit() {
        return limit;
    }
	
    /*如果显示的页数大于1小于等于100*/
    public void setLimit(int limit) {
        if (limit >= 1 && limit <= 100) {
            this.limit = limit;
        }
    }

    public int getRows() {
        return rows;
    }

    public void setRows(int rows) {
        if (rows >= 0) {
            this.rows = rows;
        }
    }

    public String getPath() {
        return path;
    }

    public void setPath(String path) {
        this.path = path;
    }

    /**
     * 获取当前页的起始行
     *
     * @return
     */
    public int getOffset() {
        // current * limit - limit
        return (current - 1) * limit;
    }

    /**
     * 获取总页数
     *
     * @return
     */
    public int getTotal() {
        // rows / limit [+1]
        if (rows % limit == 0) {
            return rows / limit;
        } else {
            return rows / limit + 1;
        }
    }

    /**
     * 获取起始页码
     *
     * @return
     */
    public int getFrom() {
        int from = current - 2;
        return Math.max(from, 1);
    }

    /**
     * 获取结束页码
     *
     * @return
     */
    public int getTo() {
        int to = current + 2;
        int total = getTotal();
        return Math.min(to, total);
    }
}
```



#### 配置类：AlphaConfog

> 由于后面很多业务场景需要用到时间的格式化，所以这里以配置类的形式写好，后期只需要将该类装配到所需的地方即可使用。

```java
package com.nowcoder.community.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.text.SimpleDateFormat;

/**
 * @author: XuYi
 * @date: 2021/11/21 11:23
 * @description:
 */
//@Configuration:表示这是一个配置类而非普通类
//配置类的方法名就是Bean的名称

@Configuration
public class AlphaConfog {
    @Bean
    public SimpleDateFormat simpleDateFormat(){
        return new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
    }
}
```

#### mapper文件：DiscussPost-mapper

> 对数据库直接操作的文件，实现对帖子的增删改查等基本操作。

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nowcoder.community.dao.DiscussPostMapper">
    <sql id="selectFields">
       id,user_id,title,content,type,status,create_time,comment_count,score
    </sql>
    <select id="selectDiscussPosts" resultType="com.nowcoder.community.entity.DiscussPost">
        select  <include refid="selectFields"/>
        from discuss_post
        where status !=2
        <if test="userId!=0">
            and userId=#{userId}
        </if>
        order by type desc ,create_time desc
        limit #{offset},#{limit}
    </select>

    <select id="selectDiscussPostRows" resultType="java.lang.Integer">
        select count(id)
        from discuss_post
        where status !=2
        <if test="userId!=0">
            and userId=#{userId}
        </if>
    </select>
</mapper>
```

#### 接口实现：Discuss-post

```java
@Repository
@Mapper
public interface DiscussPostMapper {

    List<DiscussPost> selectDiscussPosts(int userId,int offset,int limit);

    int selectDiscussPostRows(@Param("userId") int userId);

}
```

#### 服务层：DiscussPostService

```java
@Service
public class DiscussPostService {
    @Autowired
    private DiscussPostMapper discussPostMapper;

    /**
     * 查询帖子信息
     * @param userId 用户id
     * @param offset 当前页的起始行
     * @param limit 总页数
     * @return list
     */
    public List<DiscussPost> findDiscussPosts(int userId,int offset,int limit) {
        return discussPostMapper.selectDiscussPosts(userId, offset, limit);
    }

    /**
     * 根据用户id查询帖子
     * @param userId 用户id
     * @return 查询结果
     */
    public int findDiscussPostRows(int userId){
        return discussPostMapper.selectDiscussPostRows(userId);
    }

}
```

#### 控制层：HomeController

```java
@Controller
public class HomeController {
    @Autowired
    private DiscussPostService discussPostService;
    @Autowired
    private UserService userService;

    /**
     * 或取帖子数据
     * @param model model
     * @param page 分页信息
     * @return String
     */
    @RequestMapping(path = "/index",method = RequestMethod.GET)
    public String getIndexPage(Model model, Page page){
        //方法调用之前，MVC会自动实例化MODEL和PAGE,并将page注入MODEL
        page.setRows(discussPostService.findDiscussPostRows(0));
        page.setPath("/index");

        List<DiscussPost> list = discussPostService.findDiscussPosts(0, page.getOffset(), page.getLimit());
        List<Map<String,Object>> discussPosts = new ArrayList<>();
        if(!Objects.equals(list,null)){
            for (DiscussPost post : list) {
                Map<String,Object> map = new HashMap<>();
                map.put("post",post);
                User user = userService.findUserById(post.getUserId());
                map.put("user",user);
                discussPosts.add(map);
            }
        }
        model.addAttribute("discussPosts",discussPosts);
        return "/index";
    }
}
```

> 普通的Controller没什么好说的。

### 前端

#### thymeleaf模板渲染

##### 导入模板引擎并修改路径

> 再```html```头部导入如下模板引擎。

```html
xmlns:th="http://www.thymeleaf.org"
```

> 将```index.html```中的本地路径用```thymeleaf```的语法修改过来。如：
>
> ```html
> <link rel="stylesheet" th:href="@{/css/global.css}" />
> ```
>
> ```html
> 	<script th:src="@{/js/global.js}"></script>
> 	<script th:src="@{js/index.js}"></script>
> ```

##### 设置公共引用部分

> - 由于再很多不同的子页面中都需要用到```header```部分的代码内容，所以可以利用如下模板语法将该部分设为公有的引用，语法如下：
>
> ```html
> //其中的header为需要再其他页面引用到的公共部分的别名。
> th:fragment="header" 
> ```
>
> - 再在需要引用的地方加上如下代码：
>
> ```html
> //其中引号里面的内容，index表示该公共部分代码来自的页面为index.html。
> //header就是刚刚设置的一个引用别名。
> //::是必须的，是模板语法的一部分。
> th:replace="index::header"
> ```
>
> - 修改超链接标签为模板格式，如：
>
> ```html
> <a class="nav-link" th:href="@{index}">首页</a>
> <a class="nav-link" th:href="@{/register}">注册</a>
> <a class="nav-link" th:href="@{/login}">登录</a>
> ```
>
> > 语法：```th:href=@{"/xxxx"}```
>
> - 替换前端帖子修改的静态数据
>
>   > 因为最终社区首页的帖子数据是要从数据库读取的，所以需要利用模板语法进行动态的替换。
>
>   - 模板的遍历语法：```th:each="map:${discussPosts}"```
>
>   - 上面的语法表示从后台传过来的map中取得数据并以each遍历的方式循环渲染到页面中。
>
>   - 文本替换：语法```th:utext="${map.post.title}"```
>
>   - src替换：```th:src="${map.user.headerUrl}"```
>
>   - 格式化日期：```th:text="${#dates.format(map.post.createTime,'yyyy-MM-dd HH:mm:ss')}"```
>
>   - 动静结合,比如在修改某些标签的属性时，需要根据需求动态的改变属性的值：``` th:class="|page-item ${page.current==1?'disabled':''}|"```
>
>     > 先用竖线|将要修改的属性标识出来，利用${}语法进行动态替换，比如上面就表示如果当前page.curent的值为1，那就添加一个禁用属性'disabled'否则就不操作。
>
>   - 嵌套语法用法参考：```th:href="@{${page.path}(current=${i})}"```
>
> 

#### 完整代码：

```html
<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link rel="icon" href="https://static.nowcoder.com/images/logo_87_87.png"/>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" crossorigin="anonymous">
	<link rel="stylesheet" th:href="@{/css/global.css}" />
	<title>牛客网-首页</title>
</head>
<body>	
	<div class="nk-container">
		<!-- 头部 -->
		<header class="bg-dark sticky-top" th:fragment="header">
			<div class="container">
				<!-- 导航 -->
				<nav class="navbar navbar-expand-lg navbar-dark">
					<!-- logo -->
					<a class="navbar-brand" href="#"></a>
					<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
						<span class="navbar-toggler-icon"></span>
					</button>
					<!-- 功能 -->
					<div class="collapse navbar-collapse" id="navbarSupportedContent">
						<ul class="navbar-nav mr-auto">
							<li class="nav-item ml-3 btn-group-vertical">
								<a class="nav-link" th:href="@{index}">首页</a>
							</li>
							<li class="nav-item ml-3 btn-group-vertical">
								<a class="nav-link position-relative" href="site/letter.html">消息<span class="badge badge-danger">12</span></a>
							</li>
							<li class="nav-item ml-3 btn-group-vertical">
								<a class="nav-link" th:href="@{/register}">注册</a>
							</li>
							<li class="nav-item ml-3 btn-group-vertical">
								<a class="nav-link" th:href="@{/login}">登录</a>
							</li>
							<li class="nav-item ml-3 btn-group-vertical dropdown">
								<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
									<img src="http://images.nowcoder.com/head/1t.png" class="rounded-circle" style="width:30px;"/>
								</a>
								<div class="dropdown-menu" aria-labelledby="navbarDropdown">
									<a class="dropdown-item text-center" href="site/profile.html">个人主页</a>
									<a class="dropdown-item text-center" href="site/setting.html">账号设置</a>
									<a class="dropdown-item text-center" href="site/login.html">退出登录</a>
									<div class="dropdown-divider"></div>
									<span class="dropdown-item text-center text-secondary">nowcoder</span>
								</div>
							</li>
						</ul>
						<!-- 搜索 -->
						<form class="form-inline my-2 my-lg-0" action="site/search.html">
							<input class="form-control mr-sm-2" type="search" aria-label="Search" />
							<button class="btn btn-outline-light my-2 my-sm-0" type="submit">搜索</button>
						</form>
					</div>
				</nav>
			</div>
		</header>

		<!-- 内容 -->
		<div class="main">
			<div class="container">
				<div class="position-relative">
					<!-- 筛选条件 -->
					<ul class="nav nav-tabs mb-3">
						<li class="nav-item">
							<a class="nav-link active" href="#">最新</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="#">最热</a>
						</li>
					</ul>
					<button type="button" class="btn btn-primary btn-sm position-absolute rt-0" data-toggle="modal" data-target="#publishModal">我要发布</button>
				</div>
				<!-- 弹出框 -->
				<div class="modal fade" id="publishModal" tabindex="-1" role="dialog" aria-labelledby="publishModalLabel" aria-hidden="true">
					<div class="modal-dialog modal-lg" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" id="publishModalLabel">新帖发布</h5>
								<button type="button" class="close" data-dismiss="modal" aria-label="Close">
									<span aria-hidden="true">&times;</span>
								</button>
							</div>
							<div class="modal-body">
								<form>
									<div class="form-group">
										<label for="recipient-name" class="col-form-label">标题：</label>
										<input type="text" class="form-control" id="recipient-name">
									</div>
									<div class="form-group">
										<label for="message-text" class="col-form-label">正文：</label>
										<textarea class="form-control" id="message-text" rows="15"></textarea>
									</div>
								</form>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
								<button type="button" class="btn btn-primary" id="publishBtn">发布</button>
							</div>
						</div>
					</div>
				</div>
				<!-- 提示框 -->
				<div class="modal fade" id="hintModal" tabindex="-1" role="dialog" aria-labelledby="hintModalLabel" aria-hidden="true">
					<div class="modal-dialog modal-lg" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" id="hintModalLabel">提示</h5>
							</div>
							<div class="modal-body" id="hintBody">
								发布完毕!
							</div>
						</div>
					</div>
				</div>
				
				<!-- 帖子列表 -->
				<ul class="list-unstyled">
					<li class="media pb-3 pt-3 mb-3 border-bottom" th:each="map:${discussPosts}">
						<a href="site/profile.html">
							<img th:src="${map.user.headerUrl}" class="mr-4 rounded-circle user-header" alt="用户头像">
						</a>
						<div class="media-body">
							<h6 class="mt-0 mb-3">
								<a href="#" th:utext="${map.post.title}">备战春招，面试刷题跟他复习，一个月全搞定！</a>
								<span class="badge badge-secondary bg-primary" th:if="${map.post.type==1}">置顶</span>
								<span class="badge badge-secondary bg-danger" th:if="${map.post.status==1}">精华
								</span>
							</h6>
							<div class="text-muted font-size-12">
								<u class="mr-3" th:utext="${map.user.username}">寒江雪</u> 发布于 <b
									th:text="${#dates.format(map.post.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15
								15:32:18</b>
								<ul class="d-inline float-right">
									<li class="d-inline ml-2">赞 11</li>
									<li class="d-inline ml-2">|</li>
									<li class="d-inline ml-2">回帖 7</li>
								</ul>
							</div>
						</div>
					</li>
				</ul>
				<!-- 分页 -->
<!--				<nav class="mt-5" th:if="${page.rows>0}">-->
<!--				-->
<!--					<ul class="pagination justify-content-center">-->
<!--						<li class="page-item"><a class="page-link" th:href="@{${page.path}(current=1)}">首页</a>-->
<!--						</li>-->

<!--						<li th:class="|page-item ${page.current==1?'disabled' : ''}|"><a class="page-link"-->
<!--														  th:href="@{${page.path}(current=${page.current - 1})}">上一页-->
<!--						</a>-->
<!--						</li>-->

<!--						<li th:class="|page-item ${i==page.current ? 'active' : ''}|"-->
<!--							th:each="i:${#numbers.sequence(page.from,page.to)}">-->
<!--							<a class="page-link" href="#" th:text="${i}">1</a>-->
<!--						</li>-->

<!--						<li th:class="|page-item ${page.current==page.total ? 'disabled' : ''}|"><a class="page-link"-->
<!--												 th:href="@{${page.path}(current=${page.current + 1})}">下一页</a>-->
<!--						</li>-->

<!--						<li class="page-item"><a class="page-link" th:href="@{${page.path}(current=${page.total})}">末页-->
<!--						</a>-->
<!--						</li>-->
<!--					</ul>-->
<!--				</nav>-->

				<!-- 分页 -->
				<nav class="mt-5" th:if="${page.rows>0}">
					<ul class="pagination justify-content-center">
						<li class="page-item">
							<a class="page-link" th:href="@{${page.path}(current=1)}">首页</a>
						</li>
						<li th:class="|page-item ${page.current==1?'disabled':''}|">
							<a class="page-link" th:href="@{${page.path}(current=${page.current - 1})}">上一页</a></li>
						<li th:class="|page-item ${i==page.current?'active':''}|" th:each="i:${#numbers.sequence(page.from,page.to)}">
							<a class="page-link" th:href="@{${page.path}(current=${i})}" th:text="${i}">
							</a>
						</li>
						<li th:class="|page-item ${page.current==page.total?'disabled':''}|">
							<a class="page-link" th:href="@{${page.path}(current=${page.current+1})}">下一页</a>
						</li>
						<li class="page-item">
							<a class="page-link" th:href="@{${page.path}(current=${page.total})}">末页</a>
						</li>
					</ul>
				</nav>
			</div>
		</div>

		<!-- 尾部 -->
		<footer class="bg-dark">
			<div class="container">
				<div class="row">
					<!-- 二维码 -->
					<div class="col-4 qrcode">
						<img src="https://uploadfiles.nowcoder.com/app/app_download.png" class="img-thumbnail" style="width:136px;" />
					</div>
					<!-- 公司信息 -->
					<div class="col-8 detail-info">
						<div class="row">
							<div class="col">
								<ul class="nav">
									<li class="nav-item">
										<a class="nav-link text-light" href="#">关于我们</a>
									</li>
									<li class="nav-item">
										<a class="nav-link text-light" href="#">加入我们</a>
									</li>
									<li class="nav-item">
										<a class="nav-link text-light" href="#">意见反馈</a>
									</li>
									<li class="nav-item">
										<a class="nav-link text-light" href="#">企业服务</a>
									</li>
									<li class="nav-item">
										<a class="nav-link text-light" href="#">联系我们</a>
									</li>
									<li class="nav-item">
										<a class="nav-link text-light" href="#">免责声明</a>
									</li>
									<li class="nav-item">
										<a class="nav-link text-light" href="#">友情链接</a>
									</li>
								</ul>
							</div>
						</div>
						<div class="row">
							<div class="col">
								<ul class="nav btn-group-vertical company-info">
									<li class="nav-item text-white-50">
										公司地址：北京市朝阳区大屯路东金泉时代3-2708北京牛客科技有限公司
									</li>
									<li class="nav-item text-white-50">
										联系方式：010-60728802(电话)&nbsp;&nbsp;&nbsp;&nbsp;admin@nowcoder.com
									</li>
									<li class="nav-item text-white-50">
										牛客科技©2018 All rights reserved
									</li>
									<li class="nav-item text-white-50">
										京ICP备14055008号-4 &nbsp;&nbsp;&nbsp;&nbsp;
										<img src="http://static.nowcoder.com/company/images/res/ghs.png" style="width:18px;" />
										京公网安备 11010502036488号
									</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
		</footer>
	</div>

	<script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
	<script th:src="@{/js/global.js}"></script>
	<script th:src="@{js/index.js}"></script>
</body>
</html>

```

#### 启动项目

> 地址栏输入项目服务地址：```http://localhost:8080/community/index```

![](https://images.waer.ltd/img/indexs.png)

> 成功运行并加载了数据库的帖子数据。

****

## 开发社区注册功能

> 实现社区注册功能，包括邮件激活。

![](https://images.waer.ltd/img/z1.png)

#### 业务分析/描述

> 当用户点击注册之后，跳转注册页。完成注册信息的填写，如果用户点击了【立即注册】按钮，后台对输入的表单数据进行规则校验，校验通过就将注册信息写入数据库，并提示用户进行邮件激活。
>
> 大致流程图如下：

<img src="https://images.waer.ltd/img/z2.png" style="zoom:50%;" />

#### 编码工作

> 根据上面的业务需求，后端需要做的工作主要有3个，
>
> - 校验前台注册表单提交来的数据。
> - 将通过校验规则的数据写入数据库。
> - 给注册成功的用户发送激活邮件。
> - 执行账户激活操作的后端处理。



------

##### mapper.xml

> 主要是对用户表数据的增删改查，没有很复杂的sql。

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nowcoder.community.dao.UserMapper">
    <sql id="insertFields">
        username,password,salt,email,type,status,activation_code,header_url,create_time
    </sql>

    <sql id="selectFields">
        id, username,password,salt,email,type,status,activation_code,header_url,create_time
    </sql>
    <select id="selectById" resultType="com.nowcoder.community.entity.User">
        select <include refid="selectFields"/>
        from user
        where id = #{id}
    </select>

    <select id="selectByName" resultType="com.nowcoder.community.entity.User">
        select <include refid="selectFields"/>
        from user
        where username = #{username}
    </select>

    <select id="selectByEmail" resultType="com.nowcoder.community.entity.User">
        select <include refid="selectFields"/>
        from user
        where email = #{email}
    </select>

    <insert id="insertUser" parameterType="com.nowcoder.community.entity.User" keyProperty="id">
        insert into user (<include refid="insertFields"/>)
        values (#{username},#{password},#{salt},#{email},#{type},#{status},#{activationCode},#{headerUrl},#{createTime})
    </insert>

    <update id="updateStatus">
        update user set status=#{status}
        where id=#{id}
    </update>

    <update id="updateHeader">
        update user set header_url=#{headerUrl}
        where id=#{id}
    </update>

    <update id="updatePassword">
        update user set password=#{password}
        where id=#{id}
    </update>
</mapper>
```



##### DAO层

```java
@Mapper
@Repository
public interface UserMapper {
    User selectById(int id);

    User selectByName(String username);

    User selectByEmail(String email);

    int insertUser(User user);

    int updateStatus(int id,int status);

    int updateHeader(int id,String headerUrl);

    int updatePassword(int id,String password);

}
```

> 别忘了加上```@Mapper```,```@Repository```注解。



##### 服务层

> 所有实现主要功能的业务均回在这里进行处理。所以是重点。

- 需要用到的数据

  ```java
  @Autowired
  private UserMapper userMapper;
  
  @Autowired
  private MailClient mailClient;
  
  //将thymeleaf模板注入，后面发送邮件会用到
  @Autowired
  private TemplateEngine templateEngine;
  //配置路径，用于后面邮件激活功能
  @Value("${community.path.domain}")
  private String domain;
  //将配置文件里的服务路径注入进来，后面也会用到
  @Value("${server.servlet.context-path}")
  private String contextPath;
  ```

- 注册用户（写入用户信息）

  ```Java
  /**
   * 用户注册功能
   * @param user 注册用户
   * @return map
   */
  public Map<String,Object> register(User user){
      Map<String, Object> map = new HashMap<>();
      /*处理空值*/
      if(Objects.equals(user,null)){
          throw new IllegalArgumentException("参数不能为空!");
  
      }
      if(StringUtils.isBlank(user.getUsername())){
          map.put("usernameMsg","账号不能为空!");
          return map;
      }
      if(StringUtils.isBlank(user.getPassword())){
          map.put("passwordMsg","密码不能为空！");
          return map;
      }
      if(StringUtils.isBlank(user.getEmail())){
          map.put("emailMsg","邮箱不能为空！");
          return map;
      }
      /*验证账号*/
      User u = userMapper.selectByName(user.getUsername());
      if(!Objects.equals(u,null)){
          map.put("usernameMsg","该账号已存在!");
          return map;
      }
      /*验证邮箱*/
      u= userMapper.selectByEmail(user.getEmail());
      if(!Objects.equals(u,null)){
          map.put("emailMsg","该邮箱已被注册!");
          return map;
      }
      /*用户注册*/
      user.setSalt(CommunityUtil.generateUUID().substring(0,5));
      user.setPassword(CommunityUtil.md5(user.getPassword()+user.getSalt()));
      user.setType(0);
      user.setStatus(0);
      user.setActivationCode(CommunityUtil.generateUUID());
      user.setHeaderUrl(String.format("http://images.nowcoder.com/head/%dt.png",new Random().nextInt(1000)));
      user.setCreateTime(new Date());
      userMapper.insertUser(user);
      /*发送激活邮件*/
      Context context = new Context();
      context.setVariable("email",user.getEmail());
      /*http:localhost:8080/community/activation/101/code*/
      String url = domain+contextPath+"/activation/"+user.getId()+"/"+user.getActivationCode();
      context.setVariable("url",url);
      String contents = templateEngine.process("/mail/activation",context);
      mailClient.sendMail(user.getEmail(),"激活账号",contents);
      return map;
  }
  ```

  > 这里面用到了两个工具类```StringUtils```,```mail```在pom里面需要导入对应的坐标。
  >
  > ```xml
  > <!--发送邮件-->
  > <dependency>
  > <groupId>org.springframework.boot</groupId>
  > <artifactId>spring-boot-starter-mail</artifactId>
  > <version>2.5.4</version>
  > </dependency>
  > <!--字符串判空-->
  > <dependency>
  > <groupId>org.apache.commons</groupId>
  > <artifactId>commons-lang3</artifactId>
  > <version>3.9</version>
  > </dependency>
  > ```

  > 发送邮件需要配置客户端工具类```MailClient```，在utils包中创建一个```MailClient.java```类
  >
  > 具体内容如下：
  >
  > ```java
  > package com.nowcoder.community.utils;
  > import org.slf4j.Logger;
  > import org.slf4j.LoggerFactory;
  > import org.springframework.beans.factory.annotation.Autowired;
  > import org.springframework.beans.factory.annotation.Value;
  > import org.springframework.mail.javamail.JavaMailSender;
  > import org.springframework.mail.javamail.MimeMessageHelper;
  > import org.springframework.stereotype.Component;
  > import org.thymeleaf.TemplateEngine;
  > import javax.mail.MessagingException;
  > import javax.mail.internet.MimeMessage;
  > /**
  >  * @author: XuYi
  >  * @date: 2021/11/22 17:54
  >  * @description: 封装邮件发送工具客户端
  >  */
  > @Component
  > public class MailClient {
  >     //用来记录日志，方便抓邮件发送中出现的问题。
  >     private static final Logger logger = LoggerFactory.getLogger(MailClient.class);
  >     @Autowired
  >     private JavaMailSender mailSender;
  >     @Autowired
  >     private TemplateEngine templateEngine;
  > 	//发送邮件需要一个发送者的邮箱，用@value注解进行注入
  >     @Value("${spring.mail.username}")
  >     private String from;
  >     public void sendMail(String to, String subject, String content) {
  >         try {
  >             MimeMessage message = mailSender.createMimeMessage();
  >             MimeMessageHelper helper = new MimeMessageHelper(message);
  >             helper.setFrom(from);
  >             helper.setTo(to);
  >             helper.setSubject(subject);
  >             helper.setText(content, true);
  >             mailSender.send(helper.getMimeMessage());
  >         } catch (MessagingException e) {
  >             logger.error("发送邮件失败:" + e.getMessage());
  >         }
  >         logger.info("邮件发送成功");
  >     }
  > }
  > ```

  > 在```application```配置文件中配置发送者的相关信息。
  >
  > ```java
  > # Mail相关
  > 	//邮件发送方
  > spring.mail.host=smtp.sina.com
  > //端口号一般为465
  > spring.mail.port=465
  > //发送者邮箱号
  > spring.mail.username=workcoder@sina.com
  > //邮箱授权码：这里也可以填写密码，安全起见，我用的授权码
  > spring.mail.password=d6dd27b52588xxxa
  > //开启smtp
  > spring.mail.protocol=smtp
  > //安全验证
  > spring.mail.properties.mail.smtp.ssl.enable=true
  > //这条是可选的，但建议写上，避免可能出现乱七八糟的问题
  > spring.mail.properties.mail.smtp.starttls.enable=true
  > 
  > # community
  > //项目地址
  > community.path.domain =  http://localhost:8080
  > ```

- 配置邮箱相关功能，获取授权码。

> 由于我是用的新浪邮箱，所以这里就以新浪邮箱为例。

![](https://images.waer.ltd/img/z3.png)



##### 邮件激活

```Java
/**
 * 激活注册过的账号
 * @param userId 注册用户id
 * @param code 携带的激活码
 * @return 激活状态
 */
public int activation(int userId,String code){
    User user = userMapper.selectById(userId);
    if(Objects.equals(user.getStatus(),1)){
        return ACTIVATION_REPEAT;
    }else if(Objects.equals(user.getActivationCode(),code)){
        userMapper.updateStatus(userId,1);
        return ACTIVATION_SUCCESS;
    }else{
        return ACTIVATION_FAILURE;
    }
}
```

> ```CommunityConstant.java```接口

```java
package com.nowcoder.community.utils;

/**
 * @author: XuYi
 * @date: 2021/11/24 19:22
 * @description: 公用数据接口
 */
public interface CommunityConstant {
    /*激活成功*/
    int ACTIVATION_SUCCESS = 0;
    /*重复激活*/
    int ACTIVATION_REPEAT = 1;
    /*激活失败*/
    int ACTIVATION_FAILURE = 2;
}
```

- 控制层

  > 主要负责数据的分发和简单处理。

  ```java
  package com.nowcoder.community.controller;
  import com.nowcoder.community.entity.User;
  import com.nowcoder.community.service.UserService;
  import com.nowcoder.community.utils.CommunityConstant;
  import org.springframework.beans.factory.annotation.Autowired;
  import org.springframework.stereotype.Controller;
  import org.springframework.ui.Model;
  import org.springframework.web.bind.annotation.PathVariable;
  import org.springframework.web.bind.annotation.RequestMapping;
  import org.springframework.web.bind.annotation.RequestMethod;
  import java.util.Map;
  import java.util.Objects;
  /**
   * @author: XuYi
   * @date: 2021/11/24 17:15
   * @description: 登录注册
   */
  @Controller
  
  public class LoginController implements CommunityConstant {
      @Autowired
      private UserService userService;
  
      /**
       * 返回注册页面
       * @return strPage
       */
      @RequestMapping(path = "/register",method = RequestMethod.GET)
      public String getRegisterPage() {
          return "/site/register";
      }
  
      /**
       * 返回登录页面
       * @return str Page
       */
      @RequestMapping(path = "/login", method = RequestMethod.GET)
      public String getLoginPage() {
          return "/site/login";
      }
  
      /**
       * 用户注册
       * @param model model
       * @param user 用户对象
       * @return String Msg
       */
      @RequestMapping(path = "/register", method = RequestMethod.POST)
      public String register(Model model, User user){
          Map<String, Object> map = userService.register(user);
          if(Objects.equals(map,null) || map.isEmpty()){
              model.addAttribute("msg","注册成功,我们已经向您的邮箱发送了激活邮件,请尽快激活!");
              model.addAttribute("target","/index");
              return "/site/operate-result";
          }else{
              model.addAttribute("usernameMsg", map.get("usernameMsg"));
              model.addAttribute("passwordMsg", map.get("passwordMsg"));
              model.addAttribute("emailMsg", map.get("emailMsg"));
              return "/site/register";
          }
      }
  
      @RequestMapping(path = "/activation/{userId}/{code}",method = RequestMethod.GET)
      public String activation(Model model, @PathVariable("userId") int userId, @PathVariable("code") String code){
          int result = userService.activation(userId, code);
          if(result== ACTIVATION_SUCCESS){
              model.addAttribute("msg","您的账号已经可以正常使用了!");
              model.addAttribute("target","/login");
          }else if(result == ACTIVATION_REPEAT){
              model.addAttribute("msg","该账号已激活,请勿重复操作!");
              model.addAttribute("target","/index");
          }else {
              model.addAttribute("msg","激活失败,您提供的激活码不正确!");
              model.addAttribute("target","/index");
          }
          return "/site/operate-result";
      }
  }
  ```

##### 前端页面

> 获取表单数据，进行数据的校验结果回显。

```html
<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
   <link rel="icon" href="https://static.nowcoder.com/images/logo_87_87.png"/>
   <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" crossorigin="anonymous">
   <link rel="stylesheet" th:href="@{/css/global.css}" />
   <link rel="stylesheet" th:href="@{/css/login.css}" />
   <title>牛客网-注册</title>
</head>
<body>
   <div class="nk-container">
      <!-- 头部 -->
      <header class="bg-dark sticky-top" th:replace="index::header">
         <div class="container">
            <!-- 导航 -->
            <nav class="navbar navbar-expand-lg navbar-dark">
               <!-- logo -->
               <a class="navbar-brand" href="#"></a>
               <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon"></span>
               </button>
               <!-- 功能 -->
               <div class="collapse navbar-collapse" id="navbarSupportedContent">
                  <ul class="navbar-nav mr-auto">
                     <li class="nav-item ml-3 btn-group-vertical">
                        <a class="nav-link" href="../index.html">首页</a>
                     </li>
                     <li class="nav-item ml-3 btn-group-vertical">
                        <a class="nav-link position-relative" href="letter.html">消息<span class="badge badge-danger">12</span></a>
                     </li>
                     <li class="nav-item ml-3 btn-group-vertical">
                        <a class="nav-link" href="register.html">注册</a>
                     </li>
                     <li class="nav-item ml-3 btn-group-vertical">
                        <a class="nav-link" href="login.html">登录</a>
                     </li>
                     <li class="nav-item ml-3 btn-group-vertical dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                           <img src="http://images.nowcoder.com/head/1t.png" class="rounded-circle" style="width:30px;"/>
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                           <a class="dropdown-item text-center" href="profile.html">个人主页</a>
                           <a class="dropdown-item text-center" href="setting.html">账号设置</a>
                           <a class="dropdown-item text-center" href="login.html">退出登录</a>
                           <div class="dropdown-divider"></div>
                           <span class="dropdown-item text-center text-secondary">nowcoder</span>
                        </div>
                     </li>
                  </ul>
                  <!-- 搜索 -->
                  <form class="form-inline my-2 my-lg-0" action="search.html">
                     <input class="form-control mr-sm-2" type="search" aria-label="Search" />
                     <button class="btn btn-outline-light my-2 my-sm-0" type="submit">搜索</button>
                  </form>
               </div>
            </nav>
         </div>
      </header>

      <!-- 内容 -->
      <div class="main">
         <div class="container pl-5 pr-5 pt-3 pb-3 mt-3 mb-3">
            <h3 class="text-center text-info border-bottom pb-3">注&nbsp;&nbsp;册</h3>
            <form class="mt-5" method="post" th:action="@{/register}">
               <div class="form-group row">
                  <label for="username" class="col-sm-2 col-form-label text-right">账号:</label>
                  <div class="col-sm-10">
                     <input type="text"
                           th:class="|form-control ${usernameMsg!=null ? 'is-invalid' :''}| "
                           name="username"
                           id="username"
                           th:value="${user!=null ? user.username:''}"
                           placeholder="请输入您的账号!" required>
                     <div class="invalid-feedback" th:text="${usernameMsg}">
                        该账号已存在!
                     </div>
                  </div>
               </div>
               <div class="form-group row mt-4">
                  <label for="password" class="col-sm-2 col-form-label text-right">密码:</label>
                  <div class="col-sm-10">
                     <input type="password" th:class="|form-control ${passwordMsg!=null ? 'is-invalid' :''}| "
                           name="password"
                           id="password"
                           th:value="${user!=null ? user.password:''}"
                           placeholder="请输入您的密码!"
                           required>
                     <div class="invalid-feedback" th:text="${passwordMsg}">
                        密码长度不能小于8位!
                     </div>                   
                  </div>
               </div>
               <div class="form-group row mt-4">
                  <label for="confirm-password" class="col-sm-2 col-form-label text-right">确认密码:</label>
                  <div class="col-sm-10">
                     <input type="password" class="form-control"
                           id="confirm-password"
                           th:value="${user!=null ? user.password:''}"
                           placeholder="请再次输入密码!" required>
                     <div class="invalid-feedback">
                        两次输入的密码不一致!
                     </div>
                  </div>
               </div>
               <div class="form-group row">
                  <label for="email" class="col-sm-2 col-form-label text-right">邮箱:</label>
                  <div class="col-sm-10">
                     <input type="email"
                           th:class="|form-control ${emailMsg!=null ? 'is-invalid' :''}| "
                           name="email"
                           th:value="${user!=null ? user.email:''}"
                           id="email" placeholder="请输入您的邮箱!"
                           required>
                     <div class="invalid-feedback" th:text="${emailMsg}">
                        该邮箱已注册!
                     </div>
                  </div>
               </div>
               <div class="form-group row mt-4">
                  <div class="col-sm-2"></div>
                  <div class="col-sm-10 text-center">
                     <button type="submit" class="btn btn-info text-white form-control">立即注册</button>
                  </div>
               </div>
            </form>             
         </div>
      </div>

      <!-- 尾部 -->
      <footer class="bg-dark">
         <div class="container">
            <div class="row">
               <!-- 二维码 -->
               <div class="col-4 qrcode">
                  <img src="https://uploadfiles.nowcoder.com/app/app_download.png" class="img-thumbnail" style="width:136px;" />
               </div>
               <!-- 公司信息 -->
               <div class="col-8 detail-info">
                  <div class="row">
                     <div class="col">
                        <ul class="nav">
                           <li class="nav-item">
                              <a class="nav-link text-light" href="#">关于我们</a>
                           </li>
                           <li class="nav-item">
                              <a class="nav-link text-light" href="#">加入我们</a>
                           </li>
                           <li class="nav-item">
                              <a class="nav-link text-light" href="#">意见反馈</a>
                           </li>
                           <li class="nav-item">
                              <a class="nav-link text-light" href="#">企业服务</a>
                           </li>
                           <li class="nav-item">
                              <a class="nav-link text-light" href="#">联系我们</a>
                           </li>
                           <li class="nav-item">
                              <a class="nav-link text-light" href="#">免责声明</a>
                           </li>
                           <li class="nav-item">
                              <a class="nav-link text-light" href="#">友情链接</a>
                           </li>
                        </ul>
                     </div>
                  </div>
                  <div class="row">
                     <div class="col">
                        <ul class="nav btn-group-vertical company-info">
                           <li class="nav-item text-white-50">
                              公司地址：北京市朝阳区大屯路东金泉时代3-2708北京牛客科技有限公司
                           </li>
                           <li class="nav-item text-white-50">
                              联系方式：010-60728802(电话)&nbsp;&nbsp;&nbsp;&nbsp;admin@nowcoder.com
                           </li>
                           <li class="nav-item text-white-50">
                              牛客科技©2018 All rights reserved
                           </li>
                           <li class="nav-item text-white-50">
                              京ICP备14055008号-4 &nbsp;&nbsp;&nbsp;&nbsp;
                              <img src="http://static.nowcoder.com/company/images/res/ghs.png" style="width:18px;" />
                              京公网安备 11010502036488号
                           </li>
                        </ul>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </footer>
   </div>

   <script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" crossorigin="anonymous"></script>
   <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
   <script th:src="@{/js/global.js}"></script>
   <script th:src="@{/js/register.js}"></script>
</body>
</html>
```

> 激活成功之后的提示页面

```html
<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link rel="icon" href="https://static.nowcoder.com/images/logo_87_87.png"/>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" crossorigin="anonymous">
	<link rel="stylesheet" th:href="@{/css/global.css}" />
	<title>牛客网-操作结果</title>
</head>
<body class="bg-white">
<div class="nk-container">
	<!-- 头部 -->
	<header class="bg-dark sticky-top" th:replace="idx::header">
		<div class="container">
			<!-- 导航 -->
			<nav class="navbar navbar-expand-lg navbar-dark">
				<!-- logo -->
				<a class="navbar-brand" href="#"></a>
				<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
				<!-- 功能 -->
				<div class="collapse navbar-collapse" id="navbarSupportedContent">
					<ul class="navbar-nav mr-auto">
						<li class="nav-item ml-3 btn-group-vertical">
							<a class="nav-link" href="../index.html">首页</a>
						</li>
						<li class="nav-item ml-3 btn-group-vertical">
							<a class="nav-link position-relative" href="letter.html">消息<span class="badge badge-danger">12</span></a>
						</li>
						<li class="nav-item ml-3 btn-group-vertical">
							<a class="nav-link" href="register.html">注册</a>
						</li>
						<li class="nav-item ml-3 btn-group-vertical">
							<a class="nav-link" href="login.html">登录</a>
						</li>
						<li class="nav-item ml-3 btn-group-vertical dropdown">
							<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								<img src="http://images.nowcoder.com/head/1t.png" class="rounded-circle" style="width:30px;"/>
							</a>
							<div class="dropdown-menu" aria-labelledby="navbarDropdown">
								<a class="dropdown-item text-center" href="profile.html">个人主页</a>
								<a class="dropdown-item text-center" href="setting.html">账号设置</a>
								<a class="dropdown-item text-center" href="login.html">退出登录</a>
								<div class="dropdown-divider"></div>
								<span class="dropdown-item text-center text-secondary">nowcoder</span>
							</div>
						</li>
					</ul>
					<!-- 搜索 -->
					<form class="form-inline my-2 my-lg-0" action="search.html">
						<input class="form-control mr-sm-2" type="search" aria-label="Search" />
						<button class="btn btn-outline-light my-2 my-sm-0" type="submit">搜索</button>
					</form>
				</div>
			</nav>
		</div>
	</header>

	<!-- 内容 -->
	<div class="main">
		<div class="container mt-5">
			<div class="jumbotron">
				<p class="lead" th:text="${msg}">您的账号已经激活成功,可以正常使用了!</p>
				<hr class="my-4">
				<p>
					系统会在 <span id="seconds" class="text-danger">8</span> 秒后自动跳转,
					您也可以点此 <a id="target" th:href="@{${target}}" class="text-primary">链接</a>, 手动跳转!
				</p>
			</div>
		</div>
	</div>

	<!-- 尾部 -->
	<footer class="bg-dark">
		<div class="container">
			<div class="row">
				<!-- 二维码 -->
				<div class="col-4 qrcode">
					<img src="https://uploadfiles.nowcoder.com/app/app_download.png" class="img-thumbnail" style="width:136px;" />
				</div>
				<!-- 公司信息 -->
				<div class="col-8 detail-info">
					<div class="row">
						<div class="col">
							<ul class="nav">
								<li class="nav-item">
									<a class="nav-link text-light" href="#">关于我们</a>
								</li>
								<li class="nav-item">
									<a class="nav-link text-light" href="#">加入我们</a>
								</li>
								<li class="nav-item">
									<a class="nav-link text-light" href="#">意见反馈</a>
								</li>
								<li class="nav-item">
									<a class="nav-link text-light" href="#">企业服务</a>
								</li>
								<li class="nav-item">
									<a class="nav-link text-light" href="#">联系我们</a>
								</li>
								<li class="nav-item">
									<a class="nav-link text-light" href="#">免责声明</a>
								</li>
								<li class="nav-item">
									<a class="nav-link text-light" href="#">友情链接</a>
								</li>
							</ul>
						</div>
					</div>
					<div class="row">
						<div class="col">
							<ul class="nav btn-group-vertical company-info">
								<li class="nav-item text-white-50">
									公司地址：北京市朝阳区大屯路东金泉时代3-2708北京牛客科技有限公司
								</li>
								<li class="nav-item text-white-50">
									联系方式：010-60728802(电话)&nbsp;&nbsp;&nbsp;&nbsp;admin@nowcoder.com
								</li>
								<li class="nav-item text-white-50">
									牛客科技©2018 All rights reserved
								</li>
								<li class="nav-item text-white-50">
									京ICP备14055008号-4 &nbsp;&nbsp;&nbsp;&nbsp;
									<img src="http://static.nowcoder.com/company/images/res/ghs.png" style="width:18px;" />
									京公网安备 11010502036488号
								</li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
	</footer>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
<script>
	$(function(){
		setInterval(function(){
			var seconds = $("#seconds").text();
			$("#seconds").text(--seconds);
			if(seconds == 0) {
				location.href = $("#target").attr("href");
			}
		}, 1000);
	});
</script>
</body>
</html>
```



> 邮件内容发送模板

```html
<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" >
<head>
	<meta charset="utf-8">
	<link rel="icon" href="https://static.nowcoder.com/images/logo_87_87.png"/>
	<title>牛客网-激活账号</title>
</head>
<body>
<div>
	<p>
		<b th:text="${email}">xxx@xxx.com</b>, 您好!
	</p>
	<p>
		您正在注册牛客网社区, 这是一封激活邮件, 请点击
		<a th:href="${url}">此链接</a>,
		激活您的牛客社区账号!
	</p>
</div>
</body>
</html>
```

#### 启动服务，测试注册功能

> 表单校验正常

![](https://images.waer.ltd/img/z4.png)

> 注册功能正常

![](https://images.waer.ltd/img/z5.png)

****

##  kaptcha生成验证码

> 结合 kaptcha生成验证码功能。

[kaptcha官网](https://code.google.com/archive/p/kaptcha)

- 导入jar包
- 编写Kaptcha配置类
- 生成随机字符、生成图片

### 导包

```xml
<!-- https://mvnrepository.com/artifact/com.github.penggle/kaptcha -->
<dependency>
    <groupId>com.github.penggle</groupId>
    <artifactId>kaptcha</artifactId>
    <version>2.3.2</version>
</dependency>
```

#### 编写配置类

```java
   @Bean
    public Producer kaptchaProducer(){
        Properties properties = new Properties();
        /*设置宽高*/
        properties.setProperty("kaptcha.image.width","100");
        properties.setProperty("kaptcha.image.height","40");
        /*字体和颜色*/
        properties.setProperty("kaptcha.textproducer.font.size","32");
        properties.setProperty("kaptcha.textproducer.font.color","0,0,0");
        /*生成的字符串范围*/
        properties.setProperty("kaptcha.textproducer.char.string","0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ");
        /*验证码产犊：4位*/
        properties.setProperty("kaptcha.textproducer.char.length","4");
        /*干扰规则*/
        properties.setProperty("kaptcha.noise.impl","com.google.code.kaptcha.impl.NoNoise");
        DefaultKaptcha kaptcha = new DefaultKaptcha();
        Config config  = new Config(properties);
        kaptcha.setConfig(config);
        return kaptcha;
```

#### 使用

- controller层

> 自动注入
>
> ```java
>  @Autowired
>  private Producer kaptchaProducer;
> ```
>
> 请求方法:详细注释
>
> ```java
> @RequestMapping(path = "/kaptcha",method = RequestMethod.GET)
>  public void getKaptch(HttpServletResponse response , HttpSession session){
>      /*生成验证码*/
>      String text = kaptchaProducer.createText();
>      /*传入验证码生成验证码图片*/
>      BufferedImage image = kaptchaProducer.createImage(text);
>      /*将验证码存入session*/
>      session.setAttribute("kaptcha",text);
>      /*图片输出给浏览器*/
>      response.setContentType("image/png");
>      try {
>          /*以输出流写入图片*/
>          OutputStream os = response.getOutputStream();
>          ImageIO.write(image, "png", os);
>      } catch (IOException e) {
>          logger.error("响应验证码失败"+e.getMessage());
>      }
>  }
> ```
>
> 测试:输入请求路径，获得一张验证码图片，说明方法是没什么问题的。
>
> ![](https://images.waer.ltd/img/验证码.png)



#### 引入登录页

- 引入验证码

> 测试完成后，可以在登录页面进行引入了，替换前端的静态图片。

```html
<div class="col-sm-4">
<img th:src="@{/img/captcha.png}" style="width:100px;height:40px;" class="mr-2"/>
							<a href="javascript:;" class="font-size-12 align-bottom">刷新验证码</a>
</div>    
```

> 只需要将其中的img路径换掉即可。

```html
<img th:src="@{/kaptcha}" />
```

- 刷新验证码操作

> 替换超链接指向:```refresh_kaptcha(）```为刷新验证码的```javascript```方法

```html
<a href="javascript:refresh_kaptcha();" class="font-size-12 align-bottom">刷新验证码</a>
```

> 为了降低代码的复用性，将请求的项目路径放入全局JS中作为一个常量处理。

```javascript
var CONTEXT_PATH = "/community";
```

> javascript实现点击刷新验证码
>
> ```javascript
> <script>
> 		/*刷新验证码实现*/
> 		function refresh_kaptcha(){
> 			/*注意这里的/kaptcha和图片中的路径其实是一样的，为了防止浏览器误以为是同一个请求路径请求静态资源而被忽略，在后面加一些参数(参数本身对功能没有影响)*/
> 			var path = CONTEXT_PATH + "/kaptcha?p=" + Math.random();
> 			$("#kaptcha").attr("src",path);
> 		}
> 	</script>
> ```
>
> > **注意这里的/kaptcha和图片中的路径其实是一样的，为了防止浏览器误以为是同一个请求路径请求静态资源而被忽略，在后面加一些参数(参数本身对功能没有影响)**



#### 最终效果

![](https://images.waer.ltd/img/KAPTCHA.gif)

****

## 开发登录/退出

### 生成实体类```LoginTicket```

```java
	//编号
	private int id;
	//用户id
    private int userId;
	//用户凭证
    private String ticket;
	//用户状态
	private int status;
	//日期
    private Date expired;
	//对应的get、set、tiString()方法
```

### 编写Dao

> 主要就是对用户信息的增删改查实现。

```java
 /**
     * 插入实现
     * @param loginTicket loginTicket实体对象
     * @return int
     */
    int insertLoginTicket(LoginTicket loginTicket);

    /**
     * 根据用户的ticket作为条件查询用户信息
     * @param ticket 用户凭证
     * @return Ticket对象
     */
    LoginTicket selectByTicket(String ticket);

    /**
     * 修改用户状态
     * @param ticket 凭证
     * @param status 状态
     * @return int
     */
    int updateStatus(String ticket,int status);
```



### 编写对应的SQL语句

> 为了方便书写，少建一个XML文件，可以以注解的方式将```SQL```语句写在```dao```层接口中。

```java
 /**
     * 插入实现
     * @param loginTicket loginTicket实体对象
     * @return int
     */
    @Insert({
            "insert into login_ticket(user_id,ticket,status,expired) ",
            "values(#{userId},#{ticket},#{status},#{expired})"
    })
    @Options(useGeneratedKeys = true,keyProperty = "id")
    int insertLoginTicket(LoginTicket loginTicket);

    /**
     * 根据用户的ticket作为条件查询用户信息
     * @param ticket 用户凭证
     * @return Ticket对象
     */
    @Select({
            "select id,user_id,ticket,status,expired ",
            "from login_ticket where ticket = #{ticket}"
    })
    LoginTicket selectByTicket(String ticket);

    /**
     * 修改用户状态
     * @param ticket 凭证
     * @param status 状态
     * @return int
     */
    @Update({
            "<script>",
            "update login_ticket set status = #{status} where ticket=#{ticket} ",
            "<if test=\"ticket!=null\">",
            "and 1=1",
            "</if>",
            "</script>"
    })
    int updateStatus(String ticket,int status);
```

> 使用的方法也很简单。
>
> 首先判断你的接口方法需要用到什么类型的```sql```语句【```select```、```update```、```insert```、```delete```】



> 再以```@sql类型({})```的**注解形式**写在方法体的上面即可。比如```@Insert({})```



> 注解形式的```sql```支持多个字符串分开写，完了系统回自动给你进行```sql```的拼接，同样，这种方式也是支持**动态SQL**的，比如上面的```update```语句就是一个示例。需要以```<script>```标签进行包括，以标识这是动态脚本，内部的写法和在```XML```文件中书写的```SQL```没什么区别。



> 此外，如果有自动递增的字段且需要将其带回填充给对应的实体的话，需要加上注解【```@Options(useGeneratedKeys = true,keyProperty = "字段名")```】



> ```SQL```以```XML```文件的形式和以注解的形式写**都是可以的**，二者各有**优缺**。注解的方式可能用起来比较方便，毕竟直接少写了一个```XML```文件，而后者则是更便于阅读，也支持```SQL```字段的一些提示，减低了```SQL```写错的概率，所以说，如果业务涉及的```SQL```**很复杂**的情况下，建议以```XML```文件的形式。不然，注解的方式也是不错的选择。

#### 测试SQL

> 通常情况下，为了保证```SQL```的**正确性和减低后期返工的概率**，我们一般需要在后续业务代码编写之前先对已写好的```SQL```进行简单的测试。

- 在**测试包**下新建一个```MapperTest```测试类
- 加入对应的**自动装配**

```java
 @Autowired
 private LoginTicketMapper loginTicketMap;
```

- 编写I```Insert()```的测试方法：

```java
  @Test
    public void testInserLoginTicket(){
        LoginTicket loginTicket = new LoginTicket();
        loginTicket.setUserId(101);
        loginTicket.setTicket("absa");
        loginTicket.setStatus(0);
        loginTicket.setExpired(new Date(System.currentTimeMillis()+1000 * 60 * 10));
        loginTicketMap.insertLoginTicket(loginTicket);
    }
```

> 测试结果

![](https://images.waer.ltd/img/login-2.png)
![](https://images.waer.ltd/img/login-1.png)

> 测试成功，说明```Insert()```语句没问题。

------

- 编写其他两个```SQL```的测试方法.......相似的重复工作，不再贴图。

### 编写Service

> 自动装配就不说了，基操！！

> 业务层登录实现的代码:

- 方法体

```java
 /**
     * 处理登录业务
     * @param username 用户名
     * @param password 密码
     * @param expiredSeconds 过期时间(秒值)
     * @return map
     */
public Map<String,Object> login(String username,String password,int expiredSeconds){
       Map<String,Object> map = new HashMap<>();
    }
```

> 由于我们需要向客户端返回一些信息，所以返回值这里选择Map

- 空值处理

```java
   /*空值处理*/
        if(StringUtils.isBlank(username)){
            map.put("usernameMsg","账号不能为空!");
            return map;
        }
        if(StringUtils.isBlank(password)){
            map.put("passwordMsg","密码不能为空!");
            return map;
        }
```

- 合法性校验

```java
   /*合法性验证*/
        User user = userMapper.selectByName(username);
        if(Objects.equals(user,null)){
            map.put("usernameMsg","该账号不存在!");
            return map;
        }
        /*账号是否激活*/
        if(user.getStatus()==0){
            map.put("usernameMsg","该账号未激活!");
            return map;
        }
```

- 密码校验

```java
  /*密码校验*/
        password = CommunityUtil.md5(password+user.getSalt());
        if(!Objects.equals(user.getPassword(),password)){
            map.put("passwordMsg","密码不正确!");
            return map;
        }
```

- 生成登录凭证

```java
  /*生成登录凭证*/
        LoginTicket loginTicket  = new LoginTicket();
        loginTicket.setUserId(user.getId());
        loginTicket.setTicket(CommunityUtil.generateUUID());
        loginTicket.setStatus(0);
        /*过期时间为当前时间往后推移expiredSeconds*1000秒*/
        loginTicket.setExpired(new Date(System.currentTimeMillis()+expiredSeconds * 1000L));
        loginTicketMapper.insertLoginTicket(loginTicket);
        map.put("ticket",loginTicket.getTicket());
```

- 返回结果

```java
return map;
```

- 一些值得注意的地方

> 在实际的业务中，对空值的判断场景很常见，方法也比较多。
>
> 个人比较习惯的方法是利用```Objects.equals(p1,p2)```方法。这是```java.util```包下的一个工具类，专门用于处理各种值之间是否相等的判断。使用它的一个好处是你不必担心会有空指针异常抛出，因为通常的```.equals()```方法，如果使用不当很容易导致空指针，原因这里不再展开。我也是在被坑过几次之后才转粉的，相信有写过一些项目的同胞大概也和我一样教训惨痛吧。

------

### 编写(Controller)

- 方法体

  ```java
   /**
       * 请求登录方法
       * @param username 用户名
       * @param password 密码
       * @param code 验证码
       * @param rememberme 是否记住我
       * @param model 视图
       * @param session 会话
       * @param response response响应
       * @return String
       */
      @RequestMapping(path = "/login",method = RequestMethod.POST)
      public String login(String username, String password, String code, boolean rememberme,Model model,
                          HttpSession session,HttpServletResponse response){
  
      }
  ```

  > 啊这...方法参数稍微有一点长，忍一下啊!!!

  > 注意```@RequestMapping()```中，相同的```path```**不同的请求方式**视为**不同方法**，是可以的，如果二者都一样，那就会冲突。

- 验证码校验

```java
 String kaptcha =(String) session.getAttribute("kaptcha");
        /*判断验证码*/
        if(StringUtils.isBlank(kaptcha) || StringUtils.isBlank(code) || !kaptcha.equalsIgnoreCase(code)){
            model.addAttribute("codeMsg","验证码不正确!");
            return "/site/login";
        }
```

- 账号、密码校验

```java
  /*校验账号和密码*/
        int expireSeconds = rememberme ? REMEMBER_EXPIRED_SECONDS : DEFAULT_EXPIRED_SECONDS;
        Map<String, Object> map = userService.login(username, password, expireSeconds);
        if(map.containsKey("ticket")){
            Cookie cookie = new Cookie("ticket",map.get("ticket").toString());
            cookie.setPath(contextPath);
            cookie.setMaxAge(expireSeconds);
            response.addCookie(cookie);
            return "/redirect:/index";
        }else{
            model.addAttribute("usernameMsg",map.get("usernameMsg"));
            model.addAttribute("passwordMsg",map.get("passwordMsg"));
            return "/site/login";
        }
```

> **注意：**账号凭证有效期单独作为常量在```CommunityContast```类中进行声明处理。

```java
   /*默认状态登录凭证的超时时间:12小时*/
    int DEFAULT_EXPIRED_SECONDS = 3600 * 12;
    /*记住我状态超时时间:100天*/
    int REMEMBER_EXPIRED_SECONDS = 3600 * 24 * 100;
```

> 同时我们需要将凭证存到cookie中，在登录之后作为全局的一个登录凭证判断。所以cookie的有效路径是整个项目，为了不写死，可以将```application.properties```中配置好的项目路径以```@Value(${})```注解的形式放到```Controller```进行使用,具体如下:

```java
@Value("${server.servlet.context-path}")
private String contextPath;//将上述注解中的值赋给该变量
```

------

### 处理静态前端页面

- 修改登录表单的一些参数

```html
//提交方式和请求路径
method="post" th:action="@{/login}"
//用户名name属性
name = "username"
//密码name属性
name = "password"
//验证码name属性
name = "code"
//是否勾选记住我的name属性
name = "rememberme"
```

- 表单数据回显

> 由于我们在Controller中的账户信息，比如用户名和密码是以平台字符串形式入参的，所以spring是不会将他们封装到model里面的。也就是不能通过model获得，所以这里通过request的方式进行获取。
>
> 那么在thleafy中，可以用如下方式进行获取request中的数据```${param.username}```
>
> 等效于```{request.username}```
>
> ````html
> //回显用户名和密码于是否记住我的勾选
> th:value="${param.password}"
> th:value="${param.username}"  
> th:checked="${param.rememberme}"
> ````

- 其他业务调整(完整代码)

```html
	<form class="mt-5" method="post" th:action="@{/login}">
					<div class="form-group row">
						<label for="username" class="col-sm-2 col-form-label text-right">账号:</label>
						<div class="col-sm-10">
							<input type="text" th:class="| form-control ${usernameMsg!=null ? 'is-invalid':''}|"
								   th:value="${param.username}"
								   id="username"
								   name="username"
								   placeholder="请输入您的账号!" required>
							<div class="invalid-feedback" th:text="${usernameMsg}">
								该账号不存在!
							</div>
						</div>
					</div>
					<div class="form-group row mt-4">
						<label for="password" class="col-sm-2 col-form-label text-right">密码:</label>
						<div class="col-sm-10">
							<input type="password" th:class="| form-control ${passwordMsg!=null ? 'is-invalid':''}|"
								   th:value="${param.password}"
								   id="password"
								   name="password"
								   placeholder="请输入您的密码!" required>
							<div class="invalid-feedback" th:text="${passwordMsg}">
								密码长度不能小于8位!
							</div>							
						</div>
					</div>
					<div class="form-group row mt-4">
						<label for="verifycode" class="col-sm-2 col-form-label text-right">验证码:</label>
						<div class="col-sm-6">
							<input type="text" th:class="| form-control ${codeMsg!=null ? 'is-invalid':''}|"
								   name="code"
								   id="verifycode" placeholder="请输入验证码!">
							<div class="invalid-feedback" th:text="${codeMsg}">
								验证码不正确!
							</div>
						</div>
						<div class="col-sm-4">
							<img th:src="@{/kaptcha}" style="width:100px;height:40px;" class="mr-2" id="kaptcha"/>
							<a href="javascript:refresh_kaptcha();" class="font-size-12 align-bottom">刷新验证码</a>
						</div>
					</div>				
					<div class="form-group row mt-4">
						<div class="col-sm-2"></div>
						<div class="col-sm-10">
							<input type="checkbox" id="remember-me" name="rememberme"
								   th:checked="${param.rememberme}">
							<label class="form-check-label" for="remember-me">记住我</label>
							<a href="forget.html" class="text-danger float-right">忘记密码?</a>
						</div>
					</div>				
					<div class="form-group row mt-4">
						<div class="col-sm-2"></div>
						<div class="col-sm-10 text-center">
							<button type="submit" class="btn btn-info text-white form-control">立即登录</button>
						</div>
					</div>
				</form>	
```

#### 登录测试

> OK!

------

### 退出功能

- Service

```java
    /**
     * 退出登录
     * @param ticket 凭证
     */
    public void loginout(String ticket){
        loginTicketMapper.updateStatus(ticket,1);
    }
```

- Controller

```java
  /**
     * 退出登录
     * @param ticket 凭证
     * @return string
     */
    @RequestMapping(path = "/logout",method = RequestMethod.GET)
    public String logout(@CookieValue("ticket") String ticket){
        userService.logout(ticket);
        return "redirect:/login";
    }
```

- index.html页面

```html
	<a class="dropdown-item text-center" th:href="@{/logout}">退出登录</a>
```

#### 退出登录测试

> OK!

### 最终效果演示

![](https://images.waer.ltd/img/login.gif)

****



## 用户信息显示

#### 实现的基本逻辑

![](https://images.waer.ltd/img/ljq.png)



> 服务器从浏览器端获得含有登录凭证的ticket的cookie信息，将该凭证传入数据库查询获得用户的信息user。再将user传给前端引擎，重渲染之后返回页面给浏览器，从而实现用户信息的显示。

### 封装Cookie工具类

> 由于会频繁地用到cookie，所以将它封装为一个简单的静态工具类，方便调用。

> 在项目的utils包下新建一个```CookieUtil```类。

```java
package com.nowcoder.community.utils;

import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import java.util.Objects;

/**
 * @author: Tisox
 * @date: 2022/1/10 21:30
 * @description: cookie工具类的简单封装
 * @blog:www.waer.ltd
 */
public class CookieUtil {
    public static String getValue(HttpServletRequest request , String name){
        if (Objects.equals(request,null) || Objects.equals(name,null)){
            throw new IllegalArgumentException("参数为空!");
        }
        Cookie[] cookies = request.getCookies();
        if(cookies != null){
            for (Cookie cookie : cookies) {
                if(cookie.getName().equals(name)){
                    return cookie.getValue();
                }
            }
        }
        return null;
    }
}
```



### 编写Controller

> 在Controller包下新建一个Interceptor包，用来存放拦截器相关的类。
>
> 在其中编写下面的拦截器方法

```java
/**
 * @author: Tisox
 * @date: 2022/1/10 21:27
 * @description:
 * @blog:www.waer.ltd
 */
@Component
public class LoginTicketInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
       //方法主体
        return true;
    }
}
```

> 在正式编写方法内容主体之前，需要有一个查询```ticket```的方法。

#### 在UserService中

```java
/**
     * 服务层根据用户凭证查询用户的信息
     * @param ticket ticket
     * @return loginTicket
     */
    public LoginTicket findLoginTicket(String ticket){
        return loginTicketMapper.selectByTicket(ticket);
    }
```

> 很简单的一个查询，没啥好说的,继续编写拦截器逻辑。

- **preHandler**方法

```java
 /**
     * 在Controller之前执行
     * @param request req
     * @param response resp
     * @param handler handler
     * @return bool
     * @throws Exception ex
     */
@Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        String ticket = CookieUtil.getValue(request, "ticket");
        if(!Objects.equals(ticket,null)){
            /*查询凭证信息*/
            LoginTicket loginTicket = userService.findLoginTicket(ticket);
            /*检擦凭证是否还有效*/
            if(!Objects.equals(loginTicket,null) && Objects.equals(loginTicket.getStatus(),0) && loginTicket.getExpired().after(new Date())){
               /*根据凭证查询用户*/
                User user = userService.findUserById(loginTicket.getUserId());
                /*在本次请求持有用户信息*/
                /* 由于在获取用户信息的时候，浏览器对服务器是一对多的情况，需要考虑并发环境，不能简单的进行一个变量的容器存储，这里采用线程隔离的方式处理。
                *  线程隔离处理：封装为工具类：hostHolder.java
                * */
                hostHolder.setUser(user);

            }
        }
        return true;
    }

```

> 由于在获取用户信息的时候，浏览器对服务器是一对多的情况，需要考虑**并发环境**，不能简单的进行一个变量的容器存储，这里采用**线程隔离(ThreadLocal)**的方式处理。

**ThreadLocal的源码：set方法实现**

```java
public void set(T value) {
        Thread t = Thread.currentThread();
        ThreadLocalMap map = getMap(t);
        if (map != null) {
            map.set(this, value);
        } else {
            createMap(t, value);
        }
    }
```

> 可以看到，它在实现```set```方法存值处理上，是根据当前的线程来存储的，每一个线程的```map```都不同，从而实现隔离。



**ThreadLocal的源码：get方法实现**

```java
  public T get() {
        Thread t = Thread.currentThread();
        ThreadLocalMap map = getMap(t);
        if (map != null) {
            ThreadLocalMap.Entry e = map.getEntry(this);
            if (e != null) {
                @SuppressWarnings("unchecked")
                T result = (T)e.value;
                return result;
            }
        }
        return setInitialValue();
    }
```

> 再来看```get```方法也是同样的原理，根据当前线程获得一个map，再根据这个```map```去获取到对应的值。也就是说，这里的map是以线程为```key```进行值得存取。

**postHandler**方法

```java
   /**
     * 在Controller之后执行
     * @param request re
     * @param response resp
     * @param handler handler
     * @param modelAndView mv
     * @throws Exception ex
     */ 
@Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
        User user = hostHolder.getUser();
        if(!Objects.equals(user,null) && Objects.equals(modelAndView,null)){
            modelAndView.addObject("loginUser",user);
        }
    }
```

```java
 /**
     * 在TemplateEngine之后执行
     * @param request resq
     * @param response ersp
     * @param handler handler
     * @param ex ex
     * @throws Exception ex
     */
@Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
        hostHolder.clear();
    }
```

**编写HostHolder工具**

```java
package com.nowcoder.community.nkcommunity.utils;

import com.nowcoder.community.nkcommunity.entity.User;
import org.springframework.stereotype.Component;

@SuppressWarnings("all")
/**
 * @author: Tisox
 * @date: 2022/5/22 13:55
 * @description: 封装一个hostHolder本地线程根据类，用来存放用户的登录信息
 * @blog:www.waer.ltd
 */

@Component
public class HostHolder {
    private ThreadLocal<User> users= new ThreadLocal<>();

    /**
     * 获取用户信息
     * @return User
     */
    public User getUser() {
     return users.get();
    }

    /**
     * 存储用户信息
     * @param user 用户信息
     */
    public void setUser(User user){
        users.set(user);
    }

    /**
     * 销毁用户信息
     */
    public void clear(){
        users.remove();
    }
}
```

#### 拦截器的配置

```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {
    @Autowired
    private AlphaInterceptor alphaInterceptor;
    @Autowired
    private LoginTicketInterceptor loginTicketInterceptor;
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(loginTicketInterceptor)
                .excludePathPatterns("/**/*.css","/**/*.js","/**/*.png","/**/*.jpg",
                        "/**/*.jpeg");
    }

}
```

> 实现```WebMvcConfigurer```配置拦截器。



### 静态页面调整

> 调整部分的完整代码

```html
<div class="collapse navbar-collapse" id="navbarSupportedContent">
						<ul class="navbar-nav mr-auto">
							<li class="nav-item ml-3 btn-group-vertical">
								<a class="nav-link" th:href="@{index}">首页</a>
							</li>
							<li class="nav-item ml-3 btn-group-vertical" th:if="${loginUser!=null}">
								<a class="nav-link position-relative" href="site/letter.html">消息<span class="badge badge-danger">12</span></a>
							</li>
							<li class="nav-item ml-3 btn-group-vertical" th:if="${loginUser==null}">
								<a class="nav-link" th:href="@{/register}">注册</a>
							</li>
							<li class="nav-item ml-3 btn-group-vertical" th:if="${loginUser==null}">
								<a class="nav-link" th:href="@{/login}">登录</a>
							</li>
							<li class="nav-item ml-3 btn-group-vertical dropdown" th:if="${loginUser!=null}">
								<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
									<img th:src="${loginUser.headerUrl}" class="rounded-circle" style="width:30px;"/>
								</a>
								<div class="dropdown-menu" aria-labelledby="navbarDropdown">
									<a class="dropdown-item text-center" href="site/profile.html">个人主页</a>
									<a class="dropdown-item text-center" href="site/setting.html">账号设置</a>
									<a class="dropdown-item text-center" th:href="@{/logout}">退出登录</a>
									<div class="dropdown-divider"></div>
									<span class="dropdown-item text-center text-secondary"
										  th:utext="${loginUser.username}">nowcoder</span>
								</div>
							</li>
						</ul>
						<!-- 搜索 -->
						<form class="form-inline my-2 my-lg-0" action="site/search.html">
							<input class="form-control mr-sm-2" type="search" aria-label="Search" />
							<button class="btn btn-outline-light my-2 my-sm-0" type="submit">搜索</button>
						</form>
					</div>
```



### 最终效果演示

![](https://images.waer.ltd/img/users.gif)

****

## 账号设置(头像上传)

### 编写Service

```java
  /**
     * 更新用户头像路径
     * @param userId 用户id
     * @param headerUrl 头像路径
     * @return int
     */
    public int updateHeader(int userId,String headerUrl){
        return userMapper.updateHeader(userId, headerUrl);
    }
```

****



### 配置上传路径

> application.properties中添加：

```xml
community.path.upload = d:/work/data/upload
```

****



### 编写Controller

- 调整相关的跳转链接，使得跳转到账号设置正常。

- 准备引入资源

```java
    private static final Logger logger = LoggerFactory.getLogger(UserController.class);

    @Value("${community.path.upload}")
    private String uploadPath;

    @Value("${community.path.domain}")
    private String uploadDomain;

    @Value("${server.servlet.context-path}")
    private String contextPath;

    @Autowired
    private UserService userService;

    @Autowired
    private HostHolder hostHolder;
```

- **uploadHeader方法**

> 异常处理

```java
 if(Objects.equals(headerImage,null)){
            model.addAttribute("error","请选择图片!");
            return "/site/setting";
        }
 String filename = headerImage.getOriginalFilename();
        String suffix = filename.substring(filename.lastIndexOf(".")+1);
        if(StringUtils.isEmpty(suffix)){
            model.addAttribute("error","文件格式不正确！");
        }
```

> 文件重命名

```java
   /*生成随机的文件名*/
        filename = CommunityUtil.generateUUID()+suffix;
        /*确定文件存放的路径*/
        File dest = new File(uploadPath+"/"+filename);
        try {
            headerImage.transferTo(dest);
        } catch (IOException e) {
            logger.error("上传文件失败！"+e.getMessage());
            throw new RuntimeException("上传文件失败,服务器发生异常!",e);
        }
```

> 更新用户头像

```java
 /*更新当前用户的头像路径*/
        //http://locahost:8080/community/user/header/xxxx.png
        User user = hostHolder.getUser();
        String headerUrl = domain+contextPath+"/user/header/"+filename;
        userService.updateHeader(user.getId(),headerUrl);

        return "redirect:/index";
```

> 完整代码

```java
    /**
     * 上传头像
     * @param headerImage 头像
     * @param model model
     * @return Strng
     */
    @RequestMapping(path = "upload",method = RequestMethod.POST)
    public String uploadHeader(MultipartFile headerImage, Model model){
        if(Objects.equals(headerImage,null)){
            model.addAttribute("error","请选择图片!");
            return "/site/setting";
        }
        String filename = headerImage.getOriginalFilename();
        String suffix = filename.substring(filename.lastIndexOf(".")+1);
        if(StringUtils.isEmpty(suffix)){
            model.addAttribute("error","文件格式不正确！");
        }
        /*生成随机的文件名*/
        filename = CommunityUtil.generateUUID()+suffix;
        /*确定文件存放的路径*/
        File dest = new File(uploadPath+"/"+filename);
        try {
            headerImage.transferTo(dest);
        } catch (IOException e) {
            logger.error("上传文件失败！"+e.getMessage());
            throw new RuntimeException("上传文件失败,服务器发生异常!",e);
        }
        /*更新当前用户的头像路径*/
        //http://locahost:8080/community/user/header/xxxx.png
        User user = hostHolder.getUser();
        String headerUrl = domain+contextPath+"/user/header/"+filename;
        userService.updateHeader(user.getId(),headerUrl);

        return "redirect:/index";
    }
```

- **getHeader方法**

> 获取头像的方法

```java
 /*服务器存放路径*/
        fileName = uploadPath+"/"+fileName;
        /*文件后缀*/
        String suffix = fileName.substring(fileName.lastIndexOf(".") + 1);
```

> 响应图片

```java
   /*响应图片*/
        response.setContentType("image/"+suffix);
        try(   FileInputStream fis = new FileInputStream(fileName);
               OutputStream os = response.getOutputStream();) {
            byte[] buffer = new byte[1024];
            int b  = 0;
            while ((b=fis.read(buffer))!=-1){
                os.write(buffer,0,b);
            }
        } catch (IOException e) {
            logger.error("读取头像失败:"+e.getMessage());
        }
```

> 注意其中```try(){}```括号里放入声明的对象，这是```Java7```的语法，这样做的好处是，系统会自动关闭```()```里面需要关闭的资源。

****



### 静态页面调整

> - 处理返回的异常提示信息
> - 修改name属性
> - 修改表单提交参数

```html
<h6 class="text-left text-info border-bottom pb-2">上传头像</h6>
				<form class="mt-5" method="post" enctype="multipart/form-data" th:action="@{/user/upload}">
					<div class="form-group row mt-4">
						<label class="col-sm-2 col-form-label text-right">选择头像:</label>
						<div class="col-sm-10">
							<div class="custom-file">
								<input type="file" th::class="|custom-file-input ${error!=null?'is-invalid':''}|"
									   id="head-image" name="headerImage"
									   lang="es" required="">
								<label class="custom-file-label" for="head-image" data-browse="文件">选择一张图片</label>
								<div class="invalid-feedback" th:text="${error}">
									该账号不存在!
								</div>
							</div>		
						</div>
					</div>
```



**setting.html**

```html
<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link rel="icon" href="https://static.nowcoder.com/images/logo_87_87.png"/>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" crossorigin="anonymous">
	<link rel="stylesheet" th:href="@{/css/global.css}" />
	<link rel="stylesheet" th:href="@{/css/login.css}" />
	<title>牛客网-账号设置</title>
</head>
<body>
<div class="nk-container">
	<!-- 头部 -->
	<header class="bg-dark sticky-top" th:replace="index::header">
		<div class="container">
			<!-- 导航 -->
			<nav class="navbar navbar-expand-lg navbar-dark">
				<!-- logo -->
				<a class="navbar-brand" href="#"></a>
				<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
				<!-- 功能 -->
				<div class="collapse navbar-collapse" id="navbarSupportedContent">
					<ul class="navbar-nav mr-auto">
						<li class="nav-item ml-3 btn-group-vertical">
							<a class="nav-link" href="../index.html">首页</a>
						</li>
						<li class="nav-item ml-3 btn-group-vertical">
							<a class="nav-link position-relative" href="letter.html">消息<span class="badge badge-danger">12</span></a>
						</li>
						<li class="nav-item ml-3 btn-group-vertical">
							<a class="nav-link" href="register.html">注册</a>
						</li>
						<li class="nav-item ml-3 btn-group-vertical">
							<a class="nav-link" href="login.html">登录</a>
						</li>
						<li class="nav-item ml-3 btn-group-vertical dropdown">
							<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								<img src="http://images.nowcoder.com/head/1t.png" class="rounded-circle" style="width:30px;"/>
							</a>
							<div class="dropdown-menu" aria-labelledby="navbarDropdown">
								<a class="dropdown-item text-center" href="profile.html">个人主页</a>
								<a class="dropdown-item text-center" href="setting.html">账号设置</a>
								<a class="dropdown-item text-center" href="login.html">退出登录</a>
								<div class="dropdown-divider"></div>
								<span class="dropdown-item text-center text-secondary">nowcoder</span>
							</div>
						</li>
					</ul>
					<!-- 搜索 -->
					<form class="form-inline my-2 my-lg-0" action="search.html">
						<input class="form-control mr-sm-2" type="search" aria-label="Search" />
						<button class="btn btn-outline-light my-2 my-sm-0" type="submit">搜索</button>
					</form>
				</div>
			</nav>
		</div>
	</header>

	<!-- 内容 -->
	<div class="main">
		<div class="container p-5 mt-3 mb-3">
			<!-- 上传头像 -->
			<h6 class="text-left text-info border-bottom pb-2">上传头像</h6>
			<form class="mt-5" method="post" enctype="multipart/form-data" th:action="@{/user/upload}">
				<div class="form-group row mt-4">
					<label for="head-image" class="col-sm-2 col-form-label text-right">选择头像:</label>
					<div class="col-sm-10">
						<div class="custom-file">
							<input type="file" class="custom-file-input" id="head-image" name="headerImage" lang="es" required="">
							<label class="custom-file-label" for="head-image" data-browse="文件">选择一张图片</label>
						</div>
					</div>
				</div>
				<div class="form-group row mt-4">
					<div class="col-sm-2"></div>
					<div class="col-sm-10 text-center">
						<button type="submit" class="btn btn-info text-white form-control">立即上传</button>
					</div>
				</div>
			</form>
			<!-- 修改密码 -->
			<h6 class="text-left text-info border-bottom pb-2 mt-5">修改密码</h6>
			<form class="mt-5" th:action="@{/user/updatePassword}" method="post">
				<div class="form-group row mt-4">
					<label for="old-password" class="col-sm-2 col-form-label text-right">原密码:</label>
					<div class="col-sm-10">
						<input type="password" th:class="|form-control ${oldPasswordMsg!=null?'is-invalid':''}|"
							   name="oldPassword" th:value="${param.oldPassword}" id="old-password" placeholder="请输入原始密码!" required>
						<div class="invalid-feedback" th:text="${oldPasswordMsg}">
							密码长度不能小于8位!
						</div>
					</div>
				</div>
				<div class="form-group row mt-4">
					<label for="new-password" class="col-sm-2 col-form-label text-right">新密码:</label>
					<div class="col-sm-10">
						<input type="password" th:class="|form-control ${newPasswordMsg!=null?'is-invalid':''}|"
							   name="newPassword" th:value="${param.newPassword}" id="new-password" placeholder="请输入新的密码!" required>
						<div class="invalid-feedback" th:text="${newPasswordMsg}">
							密码长度不能小于8位!
						</div>
					</div>
				</div>
				<div class="form-group row mt-4">
					<label for="confirm-password" class="col-sm-2 col-form-label text-right">确认密码:</label>
					<div class="col-sm-10">
						<input type="password" class="form-control" th:value="${param.newPassword}" id="confirm-password" placeholder="再次输入新密码!" required>
						<div class="invalid-feedback">
							两次输入的密码不一致!
						</div>
					</div>
				</div>
				<div class="form-group row mt-4">
					<div class="col-sm-2"></div>
					<div class="col-sm-10 text-center">
						<button type="submit" class="btn btn-info text-white form-control">立即保存</button>
					</div>
				</div>
			</form>
		</div>
	</div>

	<!-- 尾部 -->
	<footer class="bg-dark">
		<div class="container">
			<div class="row">
				<!-- 二维码 -->
				<div class="col-4 qrcode">
					<img src="https://uploadfiles.nowcoder.com/app/app_download.png" class="img-thumbnail" style="width:136px;" />
				</div>
				<!-- 公司信息 -->
				<div class="col-8 detail-info">
					<div class="row">
						<div class="col">
							<ul class="nav">
								<li class="nav-item">
									<a class="nav-link text-light" href="#">关于我们</a>
								</li>
								<li class="nav-item">
									<a class="nav-link text-light" href="#">加入我们</a>
								</li>
								<li class="nav-item">
									<a class="nav-link text-light" href="#">意见反馈</a>
								</li>
								<li class="nav-item">
									<a class="nav-link text-light" href="#">企业服务</a>
								</li>
								<li class="nav-item">
									<a class="nav-link text-light" href="#">联系我们</a>
								</li>
								<li class="nav-item">
									<a class="nav-link text-light" href="#">免责声明</a>
								</li>
								<li class="nav-item">
									<a class="nav-link text-light" href="#">友情链接</a>
								</li>
							</ul>
						</div>
					</div>
					<div class="row">
						<div class="col">
							<ul class="nav btn-group-vertical company-info">
								<li class="nav-item text-white-50">
									公司地址：北京市朝阳区大屯路东金泉时代3-2708北京牛客科技有限公司
								</li>
								<li class="nav-item text-white-50">
									联系方式：010-60728802(电话)&nbsp;&nbsp;&nbsp;&nbsp;admin@nowcoder.com
								</li>
								<li class="nav-item text-white-50">
									牛客科技©2018 All rights reserved
								</li>
								<li class="nav-item text-white-50">
									京ICP备14055008号-4 &nbsp;&nbsp;&nbsp;&nbsp;
									<img src="http://static.nowcoder.com/company/images/res/ghs.png" style="width:18px;" />
									京公网安备 11010502036488号
								</li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
	</footer>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bs-custom-file-input/dist/bs-custom-file-input.js" crossorigin="anonymous"></script>
<script th:src="@{/js/global.js}"></script>
<script>
	$(function(){
		bsCustomFileInput.init();
	});
</script>
</body>
</html>
```



****

### 最终效果演示

![](https://images.waer.ltd/img/headerUpload.gif)

****

## 登录状态检查

> 相关的技术、知识点

- 拦截器
- 注解方式的拦截
- 自定义注解

> 实现业务

- 检查用户的登录状态
- 对用户的操作权限进行控制



### 常用的注解

> 用来实现自定义注解。

- 元注解

```@Target```:指定注解作用目标。

```@Retention```:注解的作用时间、有效期。

```@Document```:自定义注解在生成文档时要不要带上

```@Inherited```:是否继承父类注解

****

### 实现自定义注解

> 以自定义注解的方式用来对需要登录权限才能进行操作和查阅的内容进行拦截处理。

> 在项目目录下新建一个包```annotation```,包下心建一个自定义注解```LoginRequired```

```java
/**
 * @author: Tisox
 * @date: 2022/1/11 21:30
 * @description:
 * @blog:www.waer.ltd
 */
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface LoginRequired {
	//方法逻辑....
}
```

> 注解:```@Target(ElementType.METHOD)```表示该自定义注解作用再方法上。
>
> 注解```@Retention(RetentionPolicy.RUNTIME)```表示该自定义注解在项目运行时生效。

- 实现拦截器

```java
  @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        /*判断拦截到的handler是否为HandlerMethod类型*/
        if(handler instanceof HandlerMethod){
            HandlerMethod handlerMethod =  (HandlerMethod) handler;
            /*获取其中的方法列表*/
            Method method = handlerMethod.getMethod();
            /*根据方法查询其带有的指定注解*/
            LoginRequired loginRequired = method.getAnnotation(LoginRequired.class);
            /*逻辑判断:如果该方法有拦截的注解并且用户是未登录状态，就需要进行拦截*/
            if(!Objects.equals(loginRequired,null) && Objects.equals(hostHolder.getUser(),null)){
                /*重定向到登录页面*/
                response.sendRedirect(request.getContextPath()+"/login");
                return false;
            }
        }
        return true;
    }
```

> 见注释。

- 配置拦截路径

> 由于只需要对请求的方法进行拦截处理，所以所有的静态资源的请求不需要拦截，应当放行。

```java
  registry.addInterceptor(loginRequiredInterceptor)
                .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg");
```

****

### 最终效果演示

![](https://images.waer.ltd/img/req.gif)

> 可以看到，如果用户没有登录，是没办法进入相应的页面进行操作的。

****

## 敏感词过滤

> 相关的技术、知识点

- 字典树(Trie)
- Java内部类

> 实现业务

- 实现敏感词过滤算法

### 字典树

> 高效的查找树，具体参考：[字典树](https://www.waer.ltd/blog/30)

****

### 敏感词过滤算法原理

- 实现目标

> 敏感词过滤，主要利用字典树来实现，需要实现的效果是，一串可能包含有敏感词的文本，通过该过滤算法之后，将敏感词替换为特定的字符输出，比如以*替换。

- 实现原理

> 假设有如下敏感词【abc】【bf】【be】,生成对应的敏感词Trie如下

![](https://images.waer.ltd/img/t树.png)

> 初始时```p2```,```p3```指向文本串中的第一个字符，开始检查，如果```root```(```p1```指针)指向不是敏感词，```p1```,```p2```后移一位，记录该非敏感词的字符。

> 如果```root```指向有敏感词嫌疑【也就是含有敏感词的一部分字符】并且未到树结尾，那么此时```p2```标记该嫌疑字符位置，```p3```开始后移，同时配合```root```后续的字符，若此时```root==p3```但没有到达敏感词尾部，则说明该区间```[p2,p3]```内的字符串不构成敏感词，此时```root```重新指向开头，```p2```后移一位，同时```p3```也指向```p2```的位置，准备下一轮的尝试。

****

### 代码实现

> 在utils中封装该算法【```SensitiveFilter.java```】，以备后续使用。

- 创建敏感词库

> resources下创建```sensitive-words.txt```,存放敏感词。
>
> ```txt
> 赌博
> 嫖娼
> 吸毒
> 开票
> 草泥马
> ```

- 完整代码

```java
public class SensitiveFilter {

    private static final Logger logger = LoggerFactory.getLogger(SensitiveFilter.class);

    // 替换符
    private static final String REPLACEMENT = "***";

    // 根节点
    private TrieNode rootNode = new TrieNode();
    
    @PostConstruct
    public void init() {
        try (
                InputStream is = this.getClass().getClassLoader().getResourceAsStream("sensitive-words.txt");
                BufferedReader reader = new BufferedReader(new InputStreamReader(is));
        ) {
            String keyword;
            while ((keyword = reader.readLine()) != null) {
                // 添加到前缀树
                this.addKeyword(keyword);
            }
        } catch (IOException e) {
            logger.error("加载敏感词文件失败: " + e.getMessage());
        }
    }

    // 将一个敏感词添加到前缀树中
    private void addKeyword(String keyword) {
        TrieNode tempNode = rootNode;
        for (int i = 0; i < keyword.length(); i++) {
            char c = keyword.charAt(i);
            TrieNode subNode = tempNode.getSubNode(c);

            if (subNode == null) {
                // 初始化子节点
                subNode = new TrieNode();
                tempNode.addSubNode(c, subNode);
            }

            // 指向子节点,进入下一轮循环
            tempNode = subNode;

            // 设置结束标识
            if (i == keyword.length() - 1) {
                tempNode.setKeywordEnd(true);
            }
        }
    }

    /**
     * 过滤敏感词
     *
     * @param text 待过滤的文本
     * @return 过滤后的文本
     */
    public String filter(String text) {
        if (StringUtils.isBlank(text)) {
            return null;
        }

        // 指针1
        TrieNode tempNode = rootNode;
        // 指针2
        int begin = 0;
        // 指针3
        int position = 0;
        // 结果
        StringBuilder sb = new StringBuilder();

        while (begin < text.length()) {
            char c = text.charAt(position);

            // 跳过符号
            if (isSymbol(c)) {
                // 若指针1处于根节点,将此符号计入结果,让指针2向下走一步
                if (tempNode == rootNode) {
                    sb.append(c);
                    begin++;
                }
                // 无论符号在开头或中间,指针3都向下走一步
                position++;
                continue;
            }

            // 检查下级节点
            tempNode = tempNode.getSubNode(c);
            if (tempNode == null) {
                // 以begin开头的字符串不是敏感词
                sb.append(text.charAt(begin));
                // 进入下一个位置
                position = ++begin;
                // 重新指向根节点
                tempNode = rootNode;
            } else if (tempNode.isKeywordEnd()) {
                // 发现敏感词,将begin~position字符串替换掉
                sb.append(REPLACEMENT);
                // 进入下一个位置
                begin = ++position;
                // 重新指向根节点
                tempNode = rootNode;
            } else {

                // 检查下一个字符
                if(position<text.length()-1){
                    position++;
                }
            }
        }
        return sb.toString();
    }

    // 判断是否为符号
    private boolean isSymbol(Character c) {
        // 0x2E80~0x9FFF 是东亚文字范围
        return !CharUtils.isAsciiAlphanumeric(c) && (c < 0x2E80 || c > 0x9FFF);
    }

    // 前缀树
    private class TrieNode {

        // 关键词结束标识
        private boolean isKeywordEnd = false;

        // 子节点(key是下级字符,value是下级节点)
        private Map<Character, TrieNode> subNodes = new HashMap<>();

        public boolean isKeywordEnd() {
            return isKeywordEnd;
        }

        public void setKeywordEnd(boolean keywordEnd) {
            isKeywordEnd = keywordEnd;
        }

        // 添加子节点
        public void addSubNode(Character c, TrieNode node) {
            subNodes.put(c, node);
        }

        // 获取子节点
        public TrieNode getSubNode(Character c) {
            return subNodes.get(c);
        }

    }
```

****

### 测试

> 测试算法是否可用。

```java
package com.nowcoder.community;

import com.nowcoder.community.utils.SensitiveFilter;
import lombok.extern.slf4j.Slf4j;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringRunner;

/**
 * @author: Tisox
 * @date: 2022/1/12 15:05
 * @description:
 * @blog:www.waer.ltd
 */
@Slf4j
@RunWith(SpringRunner.class)
@SpringBootTest
@ContextConfiguration(classes = CommunityApplication.class)
public class SensitiveTests {
    @Autowired
    private SensitiveFilter sensitiveFilter;

    @Test
    public void testSensitiveFilter(){
        String text = "这里可以赌博，我草泥马，来吸毒啊，开票啦！@吸毒";
         text = sensitiveFilter.filter(text);
        System.out.println(text);
    }
}
```

- 测试结果

![](https://images.waer.ltd/img/sen.png)

****

## 社区帖发布

> 技术、知识点

- `AJAX(Asynchronous JavaScript and XML)`
- `JQuery`

> 实现业务

- 实现发帖功能。

### 准备阶段

- 导包

> Fastjson

```xml
<!-- https://mvnrepository.com/artifact/com.alibaba/fastjson -->
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>fastjson</artifactId>
    <version>1.2.79</version>
</dependency>
```

- 封装一个JSON信息工具

```java
    public static String getJSONString(int code, String msg, Map<String,Object> map){
        JSONObject json = new JSONObject();
        json.put("code",code);
        json.put("msg",msg);
        if(map!=null){
            for(String key: map.keySet()){
                json.put(key,map.get(key));
            }
        }
        return json.toJSONString();
    }

    public static String getJSONString(int code,String msg){
        return getJSONString(code, msg, null);
    }

    public static String getJSONString (int code){
        return getJSONString(code,null,null);
    }
```

****



### 编写Dao代码

```java
int insertDiscussPost(DiscussPost discussPost);
```

**对应的SQL**

```sql
  <sql id="insertFields">
        user_id,title,content,type,status,create_time,comment_count,score
    </sql>
      <!--插入帖子-->
    <insert id="insertDiscussPost" parameterType="com.nowcoder.community.entity.DiscussPost">
        insert into discuss_post(<include refid="insertFields"></include>)
        values(#{userId},#{title},#{content},#{type},#{status},#{createTime},#{commentCount},#{score})
    </insert>
```

****



### 编写Service代码

- 方法体

```java
 /**
     * 添加帖子
     * @param post 帖子
     * @return int
     */
    public int addDiscussPost(DiscussPost post){
        //方法内容
    }
```

- 方法内容

> 参数判断

```java
 /*参数判断*/
if(post==null){
      throw new IllegalArgumentException("参数不能为空！");
  }
```

> HTML转义:由于帖子中的标题和内容部分可能会被一些坏吕人或者是坏蓝人写入一些HTML类似的标签或者JS脚本，因此需要用到spring提供的```HtmlUtils.htmlEscape(post.getTitle())```工具进行转义处理。

```java
    	/*转义HTML标记*/
        post.setTitle(HtmlUtils.htmlEscape(post.getTitle()));
        post.setContent(HtmlUtils.htmlEscape(post.getContent()));
```

> 敏感词过滤：同样是标题和帖子内容，需要进行敏感词的过滤，敏感词过滤算法，参考我的上一篇笔记：[项目【牛客社区】开发笔记9:实现敏感词过滤算法](https://www.waer.ltd/blog/37)。

```java
  		/*敏感词过滤*/
        post.setTitle(sensitiveFilter.filter(post.getTitle()));
        post.setContent(sensitiveFilter.filter(post.getContent()));
```

> return post

```java
   return discussPostMapper.insertDiscussPost(post);
```

****



### 编写Controller代码

```java
@RequestMapping(path = "/add",method = RequestMethod.POST)
@ResponseBody
    public String addDiscussPost(String title,String content){
        User user = hostHolder.getUser();
        if(Objects.equals(user,null){
            return CommunityUtil.getJSONString(403,"你还没有登录哈！");
        }
        DiscussPost post = new DiscussPost();
        post.setUserId(user.getId());
        post.setTitle(title);
        post.setContent(content);
        post.setCreateTime(new Date());
        discussPostService.addDiscussPost(post);
        //之后将会集中处理报错信息
        return CommunityUtil.getJSONString(0,"发布成功!");
    }
```

> 别忘了注入相关的依赖。

****



### 编写静态页面(包括JS)

- index.html

> 主要处理未登录状态下【发布帖子】按钮的隐藏

```html
		<button type="button" class="btn btn-primary btn-sm position-absolute rt-0" data-toggle="modal"
							data-target="#publishModal" th:if="${loginUser!=null}">我要发布</button>
```

- index.js

```javascript
$(function(){
	$("#publishBtn").click(publish);
});

function publish() {
	$("#publishModal").modal("hide");
	//获取标题和内容
	var title = $("#recipient-name").val();
	var content = $("#message-text").val();
	//发布异步请求
	$.post(
		CONTEXT_PATH+"/discuss/add",
		{
			title:title,
			content:content,		},
			function(data){
				data = $.parseJSON(data);
				//在提示框中显示返回的消息
				$("#hintBody").text(data.msg);
				//显示提示框
				$("#hintModal").modal("show");
				//2s后自动关闭提示框
				setTimeout(function(){
					$("#hintModal").modal("hide");
					//刷新页面
					if(data.code===0){
						window.location.reload();
					}
				}, 2000);
			}
	)
}
```

> 处理前端表单的动态显示，发送Ajax异步请求，实现帖子发布于提示信息显示。

****

### 最终效果演示

![](https://images.waer.ltd/img/dis.gif)



![](https://images.waer.ltd/img/moyu.gif)

****

## 帖子详情页

> 开发帖子详情页

- 增加帖子标题跳转
- 处理静态资源访问路径
- 显示标题、作者、发布时间、帖子正文等内容。

### 编写Dao代码

- mapper

> 主要就是一个查询方法

```java
DiscussPost selectDiscussPostById(int id);
```

- mapperXML

```xml
  <!--处理帖子详情-->
    <select id="selectDiscussPostById" resultType="com.nowcoder.community.entity.DiscussPost">
        select  <include refid="selectFields"/>
        from discuss_post
        where id=#{id}
    </select>
```

****

### 编写Service代码

```java
 /**
     * 处理帖子详情
     * @param id 帖子id
     * @return 帖子对象实体
     */
    public DiscussPost findDiscussPostById(int id){
        return discussPostMapper.selectDiscussPostById(id);
    }
```

****

### 编写Controller代码

```java
  /**
     * 查询帖子详情
     * @param discussPostId 帖子id
     * @param model model
     * @return String
     */
    @RequestMapping(path = "/detail/{discussPostId}",method = RequestMethod.GET)
    public String getDiscussPost(@PathVariable("discussPostId") int discussPostId, Model model){
        /*查询帖子*/
        DiscussPost post = discussPostService.findDiscussPostById(discussPostId);
        model.addAttribute("post",post);
        /*查询帖子作者*/
        User user = userService.findUserById(post.getUserId());
        model.addAttribute("user",user);
        
        return "/site/discuss-detail";
    }
```

> 帖子详情还有评论等信息，会在后续的开发中逐步完善。

****

### 静态页面处理

- 处理首页index.html

> 调整链接地址

```html
<a th:href="@{|/discuss/detail/${map.post.id}|}"
```

- 处理详情页discuss-detail.html

```html
	<!-- 帖子详情 -->
			<div class="container">
				<!-- 标题 -->
				<h6 class="mb-4">
					<img src="http://static.nowcoder.com/images/img/icons/ico-discuss.png"/>
					<span th:utext="${post.title}">备战春招，面试刷题跟他复习，一个月全搞定！</span>
					<div class="float-right">
						<button type="button" class="btn btn-danger btn-sm">置顶</button>
						<button type="button" class="btn btn-danger btn-sm">加精</button>
						<button type="button" class="btn btn-danger btn-sm">删除</button>
					</div>
				</h6>
				<!-- 作者 -->
				<div class="media pb-3 border-bottom">
					<a href="profile.html">
						<img th:src="${user.headerUrl}"
							 class="align-self-start mr-4 rounded-circle user-header" alt="用户头像" >
					</a>
					<div class="media-body">
						<div class="mt-0 text-warning" th:utext="${user.username}">寒江雪</div>
						<div class="text-muted mt-3">
							发布于 <b th:text="${#dates.format(post.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15
							15:32:18</b>
							<ul class="d-inline float-right">
								<li class="d-inline ml-2"><a href="#" class="text-primary">赞 11</a></li>
								<li class="d-inline ml-2">|</li>
								<li class="d-inline ml-2"><a href="#replyform" class="text-primary">回帖 7</a></li>
							</ul>
						</div>
					</div>
				</div>	
				<!-- 正文 -->
				<div class="mt-4 mb-3 content" th:utext="${post.content}">
					金三银四的金三已经到了，你还沉浸在过年的喜悦中吗？
					如果是，那我要让你清醒一下了：目前大部分公司已经开启了内推，正式网申也将在3月份陆续开始，金三银四，春招的求职黄金时期已经来啦！！！
					再不准备，作为19应届生的你可能就找不到工作了。。。作为20届实习生的你可能就找不到实习了。。。
					现阶段时间紧，任务重，能做到短时间内快速提升的也就只有算法了，
					那么算法要怎么复习？重点在哪里？常见笔试面试算法题型和解题思路以及最优代码是怎样的？
					跟左程云老师学算法，不仅能解决以上所有问题，还能在短时间内得到最大程度的提升！！！
				</div>
			</div>
```



****

### 最终效果演示

![](https://images.waer.ltd/img/deta.gif)

****

## 评论/回复信息显示

> 显示评论

- 数据层
  - 根据实体查询一页评论数据
  - 根据实体查询评论的数量
- 业务层
  - 处理查询评论的业务
  - 处理查询评论数量的业务
- 表现层次
  - 显示帖子详情数据时，同时显示该帖子所有评论数据。

### 编写实体类

```java
  	private int id;
    private int userId;
    private int entityType;
    private int entityId;
    private int targetId;
    private String content;
    private int status;
    private Date createTime;
	//get/set等方法
```

****

### 编写dao代码

- Mapper接口

```java
   List<Comment> selectCommentsByEntity(int entityType,int entityId,int offset,int limit);

    int selectCountByEntity(int enetype,int entityId);

```

- Mapper.XML

```xml
 <sql id="selectFields">
      id,user_id,entity_type,entity_id,target_id,content,status,create_time
  </sql>
    <select id="selectCommentsByEntity" resultType="com.nowcoder.community.entity.Comment">
        select<include refid="selectFields"/>
        from comment
        where status = 0
        and entity_type = #{entityType}
        and entity_id = #{entityId}
        order by create_time asc
        limit #{offset},#{limit}
    </select>
    <select id="selectCountByEntity" resultType="java.lang.Integer">
        select count(id)
        from comment
        where status = 0
          and entity_type = #{entityType}
          and entity_id = #{entityId}
    </select>
```

****

### 编写Service

```java
  @Autowired
    private CommentMapper commentMapper;

    /**
     * 查询评论数据
     * @param entityType 信息类型
     * @param entityId 类型id
     * @param offset 分页
     * @param limit li
     * @return list
     */
    public List<Comment> findCommentsByEntity(int entityType,int entityId,int offset,int limit){
        return commentMapper.selectCommentsByEntity(entityType, entityId, offset, limit);
    }

    /**
     * 统计评论数
     * @param entityType ty
     * @param entityId tyid
     * @return int
     */
    public int findCommentCount(int entityType,int entityId){
        return commentMapper.selectCountByEntity(entityType, entityId);
    }
```

****

### 编写Controller

- 添加实体类型常量

```java
/*实体类型：帖子*/
int ENTITY_TYPE_POST=1;
/*实体类型：评论*/
int ENTITY_TYPE_COMMENT=2;
```

- 修改之前的```DiscussPostController```的方法

> 由于需要显示帖子的评论信息，再次修改之前的```getDiscussPost```方法如下

> 添加```Page```对象，用来实现分页

> 其他修改的地方

```java
   //查询评论的分页信息
        page.setLimit(5);
        page.setPath("/discuss/detail/"+discussPostId);
        page.setRows(post.getCommentCount());
        //评论：给帖子的评论
        //回复：给评论的评论
        //评论列表
        List<Comment> commentList = commentService.findCommentsByEntity(ENTITY_TYPE_POST, post.getId(), page.getOffset(), page.getLimit());

        //评论VO列表
        List<Map<String,Object>> commentVoList = new ArrayList<>();
        if(commentList!=null){
            for(Comment comment : commentList){
                //评论VO
                Map<String,Object>  commentVo = new HashMap<>();
                //评论
                commentVo.put("comment",comment);
                //作者
                commentVo.put("user",userService.findUserById(comment.getUserId()));

                //查询回复
                List<Comment> replyList = commentService.findCommentsByEntity(ENTITY_TYPE_COMMENT, comment.getId(), 0, Integer.MAX_VALUE);
                //回复的VO列表
                List<Map<String,Object>>  replyVoList = new ArrayList<>();
                if(replyList != null){
                    for(Comment reply : replyList){
                        Map<String, Object> replyVo = new HashMap<>();
                        //回复
                        replyVo.put("reply",reply);
                        replyVo.put("user",userService.findUserById(reply.getUserId()));
                        //处理回复的目标
                        User target = reply.getTargetId()==0 ? null : userService.findUserById(reply.getTargetId());
                        replyVo.put("target",target);

                        replyVoList.add(replyVo);
                    }
                }
                commentVo.put("replys",replyVoList);
                //回复数量
                int replyCount = commentService.findCommentCount(ENTITY_TYPE_COMMENT, comment.getId());
                commentVo.put("replyCount",replyCount);
                commentVoList.add(commentVo);
            }
        }
      model.addAttribute("comments",commentVoList);
```

> 由于回复是一个递归的形式，需要搞清楚他们的层次关系，相对比较复杂。

****

### 处理静态页面

- index.html

```html
<li class="d-inline ml-2">回帖 <span th:text="${map.post.commentCount}">7</span></li>
```

- discuss-detail.html

> 处理帖子的回复

```html
<li class="media pb-3 pt-3 mb-3 border-bottom" th:each="cvo:${comments}">
						<a href="profile.html">
							<img th:src="${cvo.user.headerUrl}"
								 class="align-self-start mr-4 rounded-circle user-header" alt="用户头像" >
						</a>
						<div class="media-body">
							<div class="mt-0">
								<span class="font-size-12 text-success" th:utext="${cvo.user.username}">掉脑袋切切</span>
								<span class="badge badge-secondary float-right floor"><i
										th:text="${page.offset+cvoStat.count}">1
								</i>#</span>
							</div>
							<div class="mt-2" th:utext="${cvo.comment.content}">
								这开课时间是不是有点晚啊。。。
							</div>
							<div class="mt-4 text-muted font-size-12">
								<span>发布于
									<b
											th:text="${#dates.format(cvo.comment.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15
										15:32:18</b></span>
								<ul class="d-inline float-right">
									<li class="d-inline ml-2"><a href="#" class="text-primary">赞(1)</a></li>
									<li class="d-inline ml-2">|</li>
									<li
											class="d-inline ml-2"><a href="#" class="text-primary" >回复
										<i th:text="${cvo.replyCount}">
										(2)</i>
									</a></li>
								</ul>
							</div>
```

> 处理回复的回复

```html
<ul class="list-unstyled mt-4 bg-gray p-3 font-size-12 text-muted">
								<!-- 第1条回复 -->
								<li class="pb-3 pt-3 mb-3 border-bottom" th:each="rvo:${cvo.replys}">
									<div>
										<span th:if="${rvo.target==null}">
											<b class="text-info" th:text="${rvo.user.username}">寒江雪</b>:&nbsp;
											&nbsp;</span>
										<span th:if="${rvo.target!=null}">
											<i class="text-info" th:text="${rvo.user.username}">sssi</i>回复
											<b class="text-info" th:text="${rvo.target.username}">寒江雪</b>:&nbsp;
											&nbsp;</span>
										<span th:utext="${rvo.reply.content}">这个是直播时间哈，觉得晚的话可以直接看之前的完整录播的~</span>
									</div>
									<div class="mt-3">
										<span
												th:text="${#dates.format(rvo.reply.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15 15:32:18</span>
										<ul class="d-inline float-right">
											<li class="d-inline ml-2"><a href="#" class="text-primary">赞(1)</a></li>
											<li class="d-inline ml-2">|</li>
											<li class="d-inline ml-2"><a th:href="|#huifu01-${rvoStat.count}|"
																		 data-toggle="collapse"
																		 class="text-primary">回复</a></li>
										</ul>
										<div  th:id="|huifu-${rvoStat.count}|" class="mt-4 collapse">
											<div>
												<input type="text" class="input-size" placeholder="回复寒江雪"/>
											</div>
											<div class="text-right mt-2">
												<button type="button" class="btn btn-primary btn-sm" onclick="#">&nbsp;&nbsp;回&nbsp;&nbsp;复&nbsp;&nbsp;</button>
											</div>										
										</div>
									</div>								
								</li>
```

> 处理回复列表分页
>
> 直接复用首页的分页即可。

```html
<ul class="pagination justify-content-center" th:replace="index::pagination">
```

****

### 最终效果演示
> 考虑到服务器对gif图片的加载时间，这里就不再放动图了。

![](https://images.waer.ltd/img/reply.png)

****

## 评论功能

> 数据层

- 增加评论数据
- 修改帖子的评论数量

> 业务层次

- 处理添加评论的业务
- 先增加评论，再更新帖子的评论数量

> 表现层

- 处理添加评论数据的请求
- 设置添加评论的表单

> 知识点：事务管理

### 编写Dao

> 数据访问组要提供评论增加和查询帖子的评论数量的实现。

- CommentMapper

  ```java
  //dao
  int insertComment(Comment comment);
  //SQL
   <sql id="insertFields">
          user_id,entity_type,entity_id,target_id,content,status,create_time
      </sql>
      <!--添加评论-->
      <insert id="insertComment" parameterType="com.nowcoder.community.entity.Comment">
          insert into comment (<include refid="insertFields"/>)
          values(#{userId},#{entityType},#{entityId},#{targetId},#{content},#{status},#{createTime})
      </insert>
  ```

- DiscussPostMapper

```java
//dao
int updateCommentCount(int id,int commentCount);
//SQL
<update id = updateCommentCount>
    update discuss_post set comment_count = #{commentCount}
where id  =#{id}
</update>
```

****

### 编写Service

- DiscussPostService

```java
 /**
     * 查询帖子的评论数量
     * @param id 帖子id
     * @param commentCount 评论数量
     * @return int
     */
    public int updateCommentCount(int id,int commentCount){
        return discussPostMapper.updateCommentCount(id, commentCount);
    }
```

- CommentService

> 使用声明式事务的方式进行事务管理，整个操作要么成功，要么全部失败。

```java
   /**
     * 添加评论
     * @param comment 评论
     * @return int
     */
    @Transactional(isolation = Isolation.READ_COMMITTED,propagation = Propagation.REQUIRED)
    public int addComment(Comment comment){
        if(comment == null) {
            throw new IllegalArgumentException("参数不能为空!");
        }
        /*需要进行内容过滤并添加评论*/
        comment.setContent(HtmlUtils.htmlEscape(comment.getContent()));
        comment.setContent(sensitiveFilter.filter(comment.getContent()));
        int rows = commentMapper.insertComment(comment);
        /*更新帖子的评论数量*/
        if(comment.getEntityType()==ENTITY_TYPE_POST){
            int count = commentMapper.selectCountByEntity(comment.getEntityType(), comment.getEntityId());
            discussPostService.updateCommentCount(comment.getEntityId(),count);
        }
        return  rows;
    }
```

****

### 编写Controller

- CommentController

> 由于评论之后需要回到当前评论的帖子详情页，所以需要传入一个帖子的id**[discussPostId]**。

```java
    /**
     * 添加帖子评论
     * @param discussPostId
     * @param comment
     * @return
     */
    @RequestMapping(path = "/add/{discussPostId}",method = RequestMethod.POST)
    public String addComment(@PathVariable("discussPostId") int discussPostId, Comment comment){
        comment.setUserId(hostHolder.getUser().getId());
        comment.setStatus(0);
        comment.setCreateTime(new Date());
        commentService.addComment(comment);
        
        return "redirect:/discuss/detail/"+discussPostId;
    }
```

****

### 静态页面处理

- 处理回帖的评论框

```html
	<!-- 回帖输入 -->
			<div class="container mt-3">
				<form class="replyform" method="post" th:action="@{|/comment/add/${post.id}|}">
					<p class="mt-3">
						<a name="replyform"></a>
						<textarea placeholder="在这里畅所欲言你的看法吧!" name="content"></textarea>
						<input type="hidden" name="entityType" value="1">
						<input type="hidden" name="entityId" th:value="${post.id}">
					</p>
					<p class="text-right">
						<button type="submit" class="btn btn-primary btn-sm">&nbsp;&nbsp;回&nbsp;&nbsp;帖&nbsp;&nbsp;</button>
					</p>
				</form>
			</div>
		</div>
```

- 给评论评论(无回复对象)

```html
	<!-- 回复输入框 -->
								<li class="pb-3 pt-3">
									<form method="post"  th:action="@{|/comment/add/${post.id}|}">
										<div>
											<input type="text" class="input-size"  name="content" 
												   placeholder="请输入你的观点"/>
											<input type="hidden" name="entityType" value="2">
											<!--注意这里传入的是评论的id不是帖子的id了-->
											<input type="hidden" name="entityId" th:value="${cvo.comment.id}">
										</div>
										<div class="text-right mt-2">
											<button type="submit" class="btn btn-primary btn-sm" 
													onclick="#">&nbsp;&nbsp;回&nbsp;&nbsp;复&nbsp;&nbsp;</button>
										</div>
									</form>
									
								</li>
```



- 给评论评论(有回复对象)

```html
	<form  method="post"  th:action="@{|/comment/add/${post.id}|}">
												<div>
													<input type="text" name="content" class="input-size" 
														   th:placeholder="|回复${rvo.user.username}|"/>
													<input type="hidden" name="entityType" value="2">
													<!--注意这里传入的是评论的id不是帖子的id了-->
													<input type="hidden" name="entityId" th:value="${cvo.comment.id}">
													<input type="hidden" name="targetId" th:value="${rvo.user.id}">
												</div>
												<div class="text-right mt-2">
													<button type="submit" class="btn btn-primary btn-sm" 
															onclick="#">&nbsp;&nbsp;回&nbsp;&nbsp;复&nbsp;&nbsp;</button>
												</div>
											</form>
```

> 注意三者的区别处理。



****

### 最终效果展示

> 由于涉及的操作比较繁琐，特以图片的形式进行展示。

![](https://images.waer.ltd/img/comment.png)

![](https://images.waer.ltd/img/moyu.gif)

****

## 私信列表、详情

> 私信列表

- 查询当前用户的会话列表，每个会话只显示一条最新的私信。
- 支持分页显示

> 私信详情

- 查询某个会话包含的私信
- 支持分页显示

****

### 编写实体类

> 信息实体```Message.java```

```java
    /**消息编号*/
    private int id;
    /*消息发送者*/
    private int fromId;
    /*对话编号*/
    private String conversationId;
    /*对话内容*/
    private String content;
    /*消息状态*/
    private int status;
    /*消息时间*/
    private Date createTime;
```

****

### 编写Dao

- **MessageMapper**

> 主要涉及五个方法的实现。

```java
package com.nowcoder.community.dao;

import com.nowcoder.community.entity.Message;
import org.apache.ibatis.annotations.Mapper;

import java.util.List;

/**
 * @author: Tisox
 * @date: 2022/1/24 15:33
 * @description: 信息数据处理
 * @blog:www.waer.ltd
 */
@Mapper
public interface MessageMapper {
    /**
     * 查询当前用户的会话列表，针对每一个会话只返回一条最新的私信。
     * @param userId 用户id
     * @param offset 分页信息
     * @param limit 分页信息
     * @return List<Message>
     */
    List<Message> selectConversations(int userId, int offset, int limit);

    /**
     * 查询当前用户的会话数量
     * @param userId 用户id
     * @return int
     */
    int selectConversationCount(int userId);

    /**
     * 查询某个会话所包含的私信列表
     * @param conversationId 会话id
     * @param offset 分页支持
     * @param limit 分页支持
     * @return List<Message>
     */
    List<Message> selectLetters(String conversationId,int offset,int limit);

    /**
     * 查询某个会话所包含的私信数量
     * @param conversationId 会话id
     * @return int
     */
    int selectLetterCount(String conversationId);

    /**
     * 查询未读私信的数量
     * @param userId 用户id
     * @param conversationId 会话ID
     * @return int
     */
    int selectLetterUnreadCount(int userId,String conversationId);   
}
```

- **MessageMapper.xml**

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nowcoder.community.dao.MessageMapper">

<sql id="selectFields">
    id,from_id,to_id,conversation_id,content,status,create_time
</sql>
    <!--查询当前用户的会话列表，针对每一个会话只返回一条最新的私信。-->
    <select id="selectConversations" resultType="com.nowcoder.community.entity.Message">
        select <include refid="selectFields"/>
        from message
        where id in(
        select max(id) from message
        where status!=2
        and from_id!=1
        and (from_id=#{userId} or to_id=#{userId})
        group by conversation_id
        )
        order by id desc
        limit  #{offset},#{limit}
    </select>

    <select id="selectConversationCount" resultType="java.lang.Integer">
        select count(m.maxid) from (
                 select max(id) as maxid
                 from message
                 where status != 2
                   and from_id != 1
                   and (from_id = #{userId} or to_id = #{userId})
                 group by conversation_id
             )as m
    </select>

    <select id="selectLetters" resultType="com.nowcoder.community.entity.Message">
        select <include refid="selectFields"/>
        from message
        where status!=2
        and from_id!=1
        and conversation_id=#{conversationId}
        order by id desc
        limit #{offset},#{limit}
    </select>

    <select id="selectLetterCount" resultType="java.lang.Integer">
        select count(id)
        from message
        where status!=2
        and from_id!=1
        and conversation_id = #{conversationId}
    </select>

    <select id="selectLetterUnreadCount" resultType="java.lang.Integer">
        select count(id)
        from message
        where status=0
        and from_id!=1
        and to_id = #{userId}
        <if test="conversationId!=null">
            and conversation_id=#{conversationId}
        </if>
    </select>
</mapper>
```

> status注释：0-未读;1-已读;2-删除;

****

### 编写Service

```java
package com.nowcoder.community.service;

import com.nowcoder.community.dao.MessageMapper;
import com.nowcoder.community.entity.Message;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * @author: Tisox
 * @date: 2022/1/24 16:58
 * @description:
 * @blog:www.waer.ltd
 */
@Service
public class MessageService {
    
    @Autowired
    private MessageMapper messageMapper;
    
    public List<Message> findConversations(int userId,int offset ,int limit){
        return messageMapper.selectConversations(userId, offset, limit);
    }
    
    public int findConversationCount(int userId){
        return messageMapper.selectConversationCount(userId);
    }
    
    public List<Message> findLetters(String conversationId,int offset,int limit){
        return messageMapper.selectLetters(conversationId, offset, limit);
    }
    
    public int findLetterCount(String conversationId){
        return messageMapper.selectLetterCount(conversationId);
    }
    
    public int findLetterUnreadCount(int userId,String conversationId){
        return messageMapper.selectLetterUnreadCount(userId,conversationId);
    }
}
```

****

### 编写 Controller

```java
package com.nowcoder.community.controller;

import com.nowcoder.community.entity.Message;
import com.nowcoder.community.entity.Page;
import com.nowcoder.community.entity.User;
import com.nowcoder.community.service.MessageService;
import com.nowcoder.community.service.UserService;
import com.nowcoder.community.utils.HostHolder;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

import java.util.*;

/**
 * @author: Tisox
 * @date: 2022/1/24 17:05
 * @description:
 * @blog:www.waer.ltd
 *
 */
@Controller
public class MessageController {

    @Autowired
    private MessageService messageService;

    @Autowired
    private HostHolder hostHolder;

    @Autowired
    private UserService userService;
    /**
     * 私信列表
     * @param model model
     * @param page 分页信息
     * @return String
     */
    @RequestMapping(path = "/letter/list/",method = RequestMethod.GET)
    public String getLetterList(Model model, Page page){
        User user = hostHolder.getUser();
        /*分页信息*/
        page.setLimit(5);
        page.setPath("/letter/list/");
        page.setRows(messageService.findConversationCount(user.getId()));
        /*会话列表*/
        List<Message> conversationList = messageService.findConversations(user.getId(), page.getOffset(), page.getLimit());
        List<Map<String,Object>> conversations = new ArrayList<>();
        if(!Objects.equals(conversationList,null)){
            for (Message message : conversationList) {
                Map<String,Object> map = new HashMap<>();
                map.put("consversation",message);
                map.put("letterCount",messageService.findLetterCount(message.getConversationId()));
                /*未读消息数*/
                map.put("unreadCount",messageService.findLetterUnreadCount(user.getId(),message.getConversationId()));
                int targetId = user.getId()==message.getFromId()?message.getToId():message.getFromId();
                map.put("target",userService.findUserById(targetId));

                conversations.add(map);
            }
        }
        model.addAttribute("conversations",conversations);
        /*查询未读消息数【全部】*/
        int letterUnreadCount = messageService.findLetterUnreadCount(user.getId(),null);
        model.addAttribute("letterUnreadCount",letterUnreadCount);
        
        return "/site/letter";
    }
}

```

****

### 处理前端页面资源

> 由于改动的地方比较多，代码就贴主要的大部分

- letter.html

```html
	<!-- 私信列表 -->
				<ul class="list-unstyled">

					<li class="media pb-3 pt-3 mb-3 border-bottom position-relative" th:each="map:${conversations}">
						<span class="badge badge-danger" th:text="${map.unreadCount}" th:if="${map.unreadCount!=0}">3
						</span>
						<a href="profile.html">
							<img th:src="${map.target.headerUrl}"
								 class="mr-4 rounded-circle user-header" alt="用户头像" >
						</a>
						<div class="media-body">
							<h6 class="mt-0 mb-3">
								<span class="text-success" th:utext="${map.target.username}">落基山脉下的闲人</span>
								<span class="float-right text-muted font-size-12"
									  th:text="${#dates.format(map.conversation.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-28
									14:13:25</span>
							</h6>
							<div>
								<a th:href="@{|/letter/detail/${map.conversation.conversationId}|}"
								   th:utext="${map.conversation.content}">米粉车, 你来吧!</a>
								<ul class="d-inline font-size-12 float-right">
									<li
											class="d-inline ml-2"><a href="#" class="text-primary" >共 <i
											th:text="${map.letterCount}">
										5</i>
										条会话</a></li>
								</ul>
							</div>
						</div>
					</li>																																								
				</ul>
```

- letter-detail.html

```html
	<!-- 私信列表 -->
				<ul class="list-unstyled mt-4">
					<li class="media pb-3 pt-3 mb-2" th:each="map:${letters}">
						<a href="profile.html">
							<img th:src="${map.fromUser.headerUrl}"
								 class="mr-4 rounded-circle user-header" alt="用户头像" >
						</a>
						<div class="toast show d-lg-block" role="alert" aria-live="assertive" aria-atomic="true">
							<div class="toast-header">
								<strong class="mr-auto" th:utext="${map.fromUser.username}">落基山脉下的闲人</strong>
								<small
										th:text="${#dates.format(map.letter.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-25
									15:49:32</small>
								<button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
									<span aria-hidden="true">&times;</span>
								</button>
							</div>
							<div class="toast-body" th:utext="${map.letter.content}">
								君不见, 黄河之水天上来, 奔流到海不复回!
							</div>
						</div>
					</li>

				</ul>
```

> 分页功能直接replace 到index::pagination复用即可。

> 在index.html中也需要修改跳转到消息的链接路径。

> 由于查看私信详情页面需要返回，调用如下JS方法即可。

```javascript
	function back(){
			location.href = CONTEXT_PATH+"/letter/list";
		}
```

****

## 私信发送、已读

> 发送私信

- 异步方式发送私信
- 发送成功后刷新私信列表

> 已读设置

- 访问私信详情时，将显示的私信设置为已读状态。

****

### 编写Dao

- MessageMapper

```java
   /**
     * 添加私信(发送私信功能)
     * @param message 私信
     * @return int
     */
    int insertMessage(Message message);


    /**
     * 修改消息状态
     * @param ids 消息id
     * @param status 状态
     * @return int
     */
    int updateStatus(List<Integer> ids,int status);
```

- message-mapper.xml

```xml
    <insert id="insertMessage" parameterType="com.nowcoder.community.entity.Message" keyProperty="id">
        insert into message(<include refid="insertFields"/>)
        values(#{fromId},#{toId},#{conversationId},#{content},#{status},#{createtime})
    </insert>

    <update id="updateStatus">
        update message set status = #{status}
        where id in
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>
```

****

### 编写Service

```java
  /**
     * 发送私信
     * @param message 信息
     * @return int
     */
    public int addMessage(Message message){
        message.setContent(HtmlUtils.htmlEscape(message.getContent()));
        message.setContent(sensitiveFilter.filter(message.getContent()));
        return messageMapper.insertMessage(message);
    }

    /**
     * 设置已读状态
     * @param ids 消息id
     * @return int
     */
    public int readMessage(List<Integer> ids){
        return messageMapper.updateStatus(ids,1);
    }
```

****

### 编写Controller

- 处理私信发送

```java
 /**
     * 异步发送私信
     * @param toName 私信接收者(发给谁)
     * @param content 私信内容
     * @return JSON信息
     */
    @RequestMapping(path = "/letter/send",method = RequestMethod.POST)
    @ResponseBody
    public String sendLetter(String toName,String content){
        User target = userService.findByUsername(toName);
        if(Objects.equals(target,null)){
            return CommunityUtil.getJSONString(1,"目标用户不存在!");
        }
        Message message = new Message();
        message.setFromId(hostHolder.getUser().getId());
        message.setToId(target.getId());
        if(message.getFromId()<message.getToId()){
            message.setConversationId(message.getFromId()+"_"+message.getToId());
        }else {
            message.setConversationId(message.getToId()+"_"+message.getFromId());
        }
        message.setContent(content);
        message.setCreateTime(new Date());
        messageService.addMessage(message);
        return CommunityUtil.getJSONString(0);
    }
```

> 注意```findByUsername()```方法需要在UserService中进行实现。
>
> 由于返回的时JSON内容，需要加上```@ResponseBody```注解。

- 处理私信已读设置

> 写一个私有方法，用来获取未读消息的列表数据。

```java
  /**
     * 获取未读消息数据
     * @param letterList 未读消息列表
     * @return List<Integer>
     */
    private List<Integer> getLetterIds(List<Message> letterList){
        List<Integer> ids = new ArrayList<>();
        if(!Objects.equals(letterList,null)){
            for (Message message : letterList) {
                if(Objects.equals(hostHolder.getUser().getId(),message.getToId()) && message.getStatus()==0){
                    ids.add(message.getId());
                }
            }
        }
        return ids;
    }
```

- 在之前的```getLetterDetail()```方法中添加如下方法，将消息设置为已读状态。

```java
 /*设置已读*/
        List<Integer> ids = getLetterIds(letterList);
        if(!ids.isEmpty()){
            messageService.readMessage(ids);
        }
```

****

### 处理前端页面

- letter.js

```javascript
function send_letter() {
	$("#sendModal").modal("hide");
	var toName = $("#recipient-name").val();
	var content = $("#message-text").val();
	$.post(
		CONTEXT_PATH + "/letter/send",
		{"toName":toName,
		"content":content
		},
		function(data) {
     		data = $.parseJSON(data);
			 if(data.code===0){
				 $("#hintBody").text("发送成功!");
			 }else {
				 $("#hintBody").text(data.msg);
			 }
			$("#hintModal").modal("show");
			setTimeout(function(){
				$("#hintModal").modal("hide");
				location.reload();
			}, 2000);

        }
	)
}
```

- letter-detail.html

> 处理自动获取私信发送者用户名

```html
	<div class="form-group">
										<label for="recipient-name" class="col-form-label">发给：</label>
										<input type="text" class="form-control" id="recipient-name"
											   th:value="${target.username}">
									</div>
```

****

## 统一异常

> 统一异常处理

- 非异步请求异常处理
- 异步请求异常处理

> 主要知识点

- ```@ExceptionHandler```
- ```@ControllerAdvice```

### 处理error页面

> 由于项目出错时需要用到错误页面，在```HomeController```中先设置好页面跳转。

```java
  /**
     * 跳转错误页面500
     * @return string
     */
    @RequestMapping(path = "/error",method = RequestMethod.GET)
    public String getErrorPage(){
        return "/error/500";
    }
```

### 统一处理异常

> 在controller包下新建一个advice包，下建一个```ExceptionAdvice```通知类。

```java
@ControllerAdvice(annotations = Controller.class)
```

只扫描带有该注解的bean，进行统一处理。

```java
/**
 * @author: Tisox
 * @date: 2022/1/27 11:44
 * @description:
 * @blog:www.waer.ltd
 */
@ControllerAdvice(annotations = Controller.class)
public class ExceptionAdvice {
    private static final Logger logger = LoggerFactory.getLogger(ExceptionAdvice.class);
    //该注解可以指定所有的错误类型，如：Exception.class，将在controller出现异常后被调用。
    @ExceptionHandler({Exception.class})
    public  void handleException(Exception e, HttpServletRequest request, HttpServletResponse response) throws IOException {
        logger.error("服务器发生异常："+e.getMessage());
        /*遍历异常的详细信息*/
        for(StackTraceElement element : e.getStackTrace()){
            logger.error(element.toString());
        }
        /*通过request来判断请求的类型：是否为异步请求*/
        String xRequestedWith = request.getHeader("x-requested-with");
        if(Objects.equals(xRequestedWith,"XMLHttprequest")){
            /*返回：plain:普通的字符串，人为处理成json*/
            response.setContentType("application/plain;charset=utf-8");
            PrintWriter writer = response.getWriter();
            writer.write(CommunityUtil.getJSONString(1,"服务器异常！"));
        }else{
            //普通请求：非异步
            response.sendRedirect(request.getContextPath() + "/error");
        }
    }
}
```

****

## 统一日志

> 统一记录日志

- 统一记录用户的操作日志，在Service中

> 主要知识点

- AOP：面向切面编程，一种对OOP的补充，可以进一步提高编程的效率。

### AOP(面向切面编程)

- **概念**

> AOP （ Aspect-Oriented Programming ，面向切面编程）：是一种新的方法论，是对传统 OOP （ Object-Oriented Programming ，面向对象编程）的补充。 AOP 的主要编程对象是切面（ aspect ），而切面即模块化横切关注点。在应用 AOP 编程时，仍然需要定义公共功能，但可以明确的定义这个功能在哪里、以什么方式应用，并且不必修改受影响的类。这样一来横切关注点就被模块化到特殊的对象——切面里。

- **术语**

> 切面（ Aspect ）：横切关注点（跨越应用程序多个模块的功能）被模块化的特殊对象；
> 通知（ Advice ）：切面必须要完成的工作；
> 目标（ Target ）:被通知的对象；
> 代理（ Proxy ）：向目标对象应用通知之后创建的对象；
> 连接点（ ```Joinpoint``` ）：程序执行的某个特定位置，如类某个方法调用前、调用后、方法抛出异常后等。连接点由两个信息确定：方法表示的程序执行点、相对点表示的方位，
> 切入点（ Pointcut ）：每个类都拥有多个连接点，类比：连接点相当于数据库中的记录，切入点相当于查询条件。切入点和连接点不是一对一的关系，一个切入点匹配多个连接点，切入点通过 org.springframework.aop.Pointcut 接口进行描述，它使用类和方法作为连接点的查询条件。

- **AspctJ**

> @Aspect 注解的 Java 类，通知是标注有某种注解的简单的 Java 方法。
> AspectJ 支持 5 种类型的通知注解：
> @Before ：前置通知，在方法执行之前执行；
> @After ：后置通知，在方法执行之后执行；
> @AfterReturning ：返回通知，在方法返回结果之后执行；
> @AfterThrowing ：异常通知，在方法抛出异常之后；
> @Around ：环绕通知，围绕着方法执行。

### SpringAOP

- JDK动态代理
  - Java提供的动态代理技术，可以在运行时创建接口的代理实例
  - SpringAOP默认采用这种方式，在接口的代理实例中织入代码
- CGLib动态代理
  - 采用底层的字节码技术，在运行时创建子类代理实例。
  - 当目标对象不存在接口时，SpringAOP会采用这种方式，在子类实例中织入代码。

> 由于本项目目标Service并没有接口实现，所以Spring会采用**CGLib动态代理**的方式。

****

### 统一记录日志

> 使用aop的方式实现对service日志的统一记录。

> **ServiceLogAspect.java**

```java
package com.nowcoder.community.aspect;
/**
 * @author: Tisox
 * @date: 2022/1/27 17:03
 * @description:
 * @blog:www.waer.ltd
 */
@Component
@Aspect
public class ServiceLogAspect {
    private static final Logger logger = LoggerFactory.getLogger(ServiceLogAspect.class);

	//表示会扫描service下所有的方法
    @Pointcut("execution(* com.nowcoder.community.service.*.*(..))")
    public void pointcut(){

    }

    @Before("pointcut()")
    public void before(JoinPoint joinPoint){
        //用户【IP】，在【时间】，访问了【com.nowcoder.community.service.xxxx()】.
        ServletRequestAttributes attributes =(ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        HttpServletRequest request = attributes.getRequest();
        String ip = request.getRemoteHost();
        String now = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date());
        /*获取目标类型名和方法名*/
        String target = joinPoint.getSignature().getDeclaringTypeName() + "."+joinPoint.getSignature().getName();
        logger.info(String.format("用户[%s],在[%s],访问了[%s].",ip,now,target));
    }
}

```



#### **一些坑和注意点**

- ```Aspect```需要和项目的```Application```在同一级。
- 注意切入点的匹配，【```@Pointcut("execution(* com.nowcoder.community.service.*.*(..))")```】

****

## 点赞功能

> 点赞

- 支持帖子、评论点赞
- 第一次点赞，第二次取消点赞

> 首页点赞数量

- 统计帖子的点赞数量

> 详情页点赞数量

- 统计点赞数量
- 显示点赞状态



### 编写工具类

> ```RedisKeyUtil```用来处理存入```redis```的键。

```java
    private static final String SPLIT = ":";

    private static final String PREFIX_ENTITY_LIKE="like:entity";

    /**
     * 某个实体的赞
     * @return String
     */
    public static String getEntityLikeKey(int entityType,int entityId){
        return  PREFIX_ENTITY_LIKE + entityType+SPLIT+entityId;
    }
```

> 因为点赞的对象必然是某个实体，如帖子或者帖子的回复，所以需要将其作为```key```存入```redist```。

****

### 编写Service

> 编写```RedisService```处理点赞相关的功能业务。

- > 判断是否已赞过

```java
   /**
     * 点赞功能
     * @param userId 用户id
     * @param entityType 实体类型
     * @param entityId 实体id
     */
    public void like(int userId,int entityType,int entityId){
        /*拼key*/
        String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);
        /*判断是否已点过赞*/
        Boolean isMumber = redisTemplate.opsForSet().isMember(entityLikeKey, userId);
        if(isMumber){
            redisTemplate.opsForSet().remove(entityLikeKey, userId);
        }else{
            redisTemplate.opsForSet().add(entityLikeKey,userId);
        }
    }
```

- > 查询某实体的点赞数量

```java
/**
     * 查询某实体的点赞数量
     * @param entityType 实体类型
     * @param entityId 实体编号
     * @return long
     */
    public long findEntityLikeCount(int entityType,int entityId){
        String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);
        return redisTemplate.opsForSet().size(entityLikeKey);
    }
```

- > ```
  > 查询对某实体的点赞状态
  > ```

```java
   /**
     * 查询对某实体的点赞状态
     * @param userId 用户id
     * @param entityType 实体类型
     * @param entityId 实体编号
     * @return int
     */
    public int findEntityLikeStatus(int userId,int entityType,int entityId){
        String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType,entityId);
        return redisTemplate.opsForSet().isMember(entityLikeKey,userId) ? 1 : 0;
    }
```

****

### 编写Controller

> 异步处理点赞功能。

```java
 @RequestMapping(path = "/like",method = RequestMethod.POST)
    @ResponseBody
    public String like(int entityType,int entityId){
        User user = hostHolder.getUser();
        /*点赞*/
        likeService.like(user.getId() ,entityType,entityId);
        /*数量*/
        long likeCount = likeService.findEntityLikeCount(entityType, entityId);
        /*状态*/
        int likeStatus = likeService.findEntityLikeStatus(user.getId(),entityType,entityId);
        Map<String,Object> map = new HashMap<>();
        map.put("likeCount",likeCount);
        map.put("likeStatus",likeStatus);
        return CommunityUtil.getJSONString(0,null,map);
    }
```

****

### 修改之前的Controller

> 由于在首页显示的帖子中，会显示被点赞的情况，因此需要修改之前的部分controller，对于帖子详情也是类似的处理。

- ```HomeController```

> 修改```getIndexPage()```方法

```java
   long  likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST, post.getId());
                map.put("likeCount",likeCount);
```

- ```DiscussPostController```

> 修改其中的两个方法

```java
//处理帖子---------------------------------------------------------------------------------
	/*点赞数*/
        long likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST,
                discussPostId);
        model.addAttribute("likeCount",likeCount);
        /*点赞状态*/
        int likeStatus =hostHolder.getUser()==null ? 0 :  likeService.findEntityLikeStatus(hostHolder.getUser().getId(),ENTITY_TYPE_POST,discussPostId);
        model.addAttribute("likeStatus",likeStatus);

//处理评论---------------------------------------------------------------------------------
 /*点赞状态*/
                 likeStatus =hostHolder.getUser()==null ? 0 :
                         likeService.findEntityLikeStatus(hostHolder.getUser().getId(),ENTITY_TYPE_COMMENT,comment.getId());
               // model.addAttribute("likeStatus",likeStatus);
                commentVo.put("likeStatus",likeStatus);
//处理回复---------------------------------------------------------------------------------
 /*点赞数*/
                        likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_COMMENT,
                                reply.getId());
                        replyVo.put("likeCount",likeCount);
                        /*点赞状态*/
                        likeStatus =hostHolder.getUser()==null ? 0 :
                                likeService.findEntityLikeStatus(hostHolder.getUser().getId(),ENTITY_TYPE_COMMENT,
                                        reply.getId());
                        replyVo.put("likeStatus",likeStatus);
```

****

### 前端页面处理

> 点赞涉及到的页面相对比较多，不再全部展示。

- ``discuss-detail.html``

```html
	<li class="d-inline ml-2">
									<a href="javascript:;" th:onclick="|like(this,1,${post.id});|"
									   class="text-primary"> <b th:text="${likeStatus==1?'已赞':'赞'}">赞</b><i
											th:text="${likeCount}">11</i>
									</a>
								</li>
```

- ```index.html```

```html
<li class="d-inline ml-2">赞 <span th:text="${map.likeCount}">11</span></li>
```

****

## 收到的赞

> 重构点赞功能

- 以用户为key，记录点赞数量
- increment(key),decrement(key)

> 开发个人主页

- 以用户为key，查询点赞数量

### 编写Utils

> 修改```RedisKeyUtil```,新增用户key

```java
  private static final String PREFIX_USER_LIKE = "like:user";

  /**
     * 某个用户的赞
     * @param userId 用户id
     * @return String
     */
    public static String getUserLikeKey(int userId){
        return PREFIX_USER_LIKE+SPLIT + userId;
    }
```

****

### 编写Service

> 修改```LikeService```的```like```方法：

```java
 redisTemplate.execute(new SessionCallback() {
            @Override
            public Object execute(RedisOperations operations) throws DataAccessException {
                String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);
                String userLikeKey = RedisKeyUtil.getUserLikeKey(entityUserId);
                boolean isMember = operations.opsForSet().isMember(entityLikeKey,userId);
                /*开启事务*/
                operations.multi();
                /*已点赞*/
                if(isMember){
                    operations.opsForSet().remove(entityLikeKey,userId);
                    operations.opsForValue().decrement(userLikeKey);
                }else{
                    /*没点赞*/
                    operations.opsForSet().add(entityLikeKey,userId);
                    operations.opsForValue().increment(userLikeKey);
                }
                return operations.exec();
            }
        });
```

> 新增```findUserLikeCount```方法

```java
  /**
     * 查询某个用户获得的赞
     * @param userId 用户id
     * @return int
     */
    public int findUserLikeCount(int userId){
        String userLikeKey = RedisKeyUtil.getUserLikeKey(userId);
        Integer count = (Integer) redisTemplate.opsForValue().get(userLikeKey);
        return count== null  ?0 : count.intValue();
    }
```





****



### 编写Controller

> 编辑之前的```UserController```,新增如下方法

```java
   /**
     * 个人主页
     * @param userId 用户id
     * @param model model
     * @return String
     */
    @RequestMapping(path = "/profile/{userId}",method = RequestMethod.GET)
    public String getProfilePage(@PathVariable("userId"),int userId,Model model){
        User user = userService.findUserById(userId);
        if(Objects.equals(user,null)){
            throw new RuntimeException("该用户不存在!");
        }
        /*用户*/
        model.addAttribute("user",user);
        /*点赞数量*/
        int likeCount = likeService.findUserLikeCount(userId);
        model.addAttribute("likeCount",likeCount);
        
        return "/site/profile";
    }
```



> 编写之前的```LikeController```

```java
   @RequestMapping(path = "/like",method = RequestMethod.POST)
    @ResponseBody
    public String like(int entityType,int entityId,int entityUserId){
        User user = hostHolder.getUser();
        /*点赞*/
        likeService.like(user.getId() ,entityType,entityId,entityUserId);
        /*数量*/
        long likeCount = likeService.findEntityLikeCount(entityType, entityId);
        /*状态*/
        int likeStatus = likeService.findEntityLikeStatus(user.getId(),entityType,entityId);
        Map<String,Object> map = new HashMap<>();
        map.put("likeCount",likeCount);
        map.put("likeStatus",likeStatus);

        return CommunityUtil.getJSONString(0,null,map);
```

****

### 处理前端页面

> ```discuss-detail.html```

```html
<li
													class="d-inline ml-2"><a href="javascript:;"
																			 th:onclick="|like(this,2,${rvo.reply.id},${rvo.reply.userId});|"
																			 class="text-primary"> <b
													th:text="${rvo.likeStatus==1?'已赞':'赞'}">赞
											</b><i
													th:text="${rvo.likeCount}">(1)
											</i>
											</a>
											</li>
```

> 其他地方类似的修改，不再贴了。主要就是新增一个参数：该实体本身的拥有者即```userId```作为第三个参数传入。

> 处理```discuss.js```

```javascript
function like(btn,entityType,entityId,entityUserId){
    $.post(
        CONTEXT_PATH + "/like",
        {"entityType":entityType,"entityId":entityId,"entityUserId":entityUserId},
        function (data){
            data = $.parseJSON(data);
            if(data.code===0){
                $(btn).children("i").text(data.likeCount);
                $(btn).children("b").text(data.likeStatus==1 ? '已赞': '赞');
            }else{
                alert(data.msg);
            }
        }
    )
}
```

> ```profile.html```

```html
<div class="media mt-5">
					<img th:src="${user.headerUrl}"
						 class="align-self-start mr-4 rounded-circle"
						 alt="用户头像" style="width:50px;">
					<div class="media-body">
						<h5 class="mt-0 text-warning">
							<span th:utext="${user.username}">nowcoder</span>
							<button type="button" class="btn btn-info btn-sm float-right mr-5 follow-btn">关注TA</button>
						</h5>
						<div class="text-muted mt-3">
							<span>注册于
								<i class="text-muted"
								   th:text="${#dates.format(user.createTime,'yyyy-MM-dd HH:mm:ss')}">2015-06-12
									15:20:12</i></span>
						</div>
						<div class="text-muted mt-3 mb-5">
							<span>关注了 <a class="text-primary" href="followee.html">5</a> 人</span>
							<span class="ml-4">关注者 <a class="text-primary" href="follower.html">123</a> 人</span>
							<span class="ml-4">获得了 <i class="text-danger" th:text="{likeCount}">87</i> 个赞</span>
						</div>
					</div>
				</div>
```

> 另外，还需要处理的页面有index.html

****

## 关注、取关

> 需求

- 开发关注、取消关注功能。
- 统计用户的关注数、粉丝数。

> 要点

- 若A关注了B，则A是B的(**Follower**)粉丝，B是A的(**Followee**)目标
- 关注的目标可以是用户、帖子、题目等，在实现时将这些目标抽象为实体。

### 编写Util

> 在```RedisKeyUtil```中添加以下内容。

```java
 /*目标：被关注者*/
    private static final String PREFIX_FOLLOWEE = "followee";
    /*粉丝：关注者*/
    private static final String PREFIX_FOLLOWER = "follower";
//-------------------------------------------------
   /**
     * 某个用户关注的实体
     * @param userId 用户id
     * @param entityType 实体类型
     * @return String
     */
    //followee:userId:entityType->zset(entityId,now)
    public static String getFolloweeKey(int userId,int entityType){
        return PREFIX_FOLLOWEE + SPLIT + userId + SPLIT + entityType;
    }

    /**
     * 某个实体拥有的粉丝
     * @param entityType 实体类型
     * @param entityId 实体id
     * @return String
     */
    //folower:entityTyoe:entityId->zset(userId,now)
    public static String getFollowerKey(int entityType,int entityId){
        return PREFIX_FOLLOWER + SPLIT + entityType + SPLIT + entityId;
    }
```

****

### 编写Service

> 新增```FollowService```,编写关注和取关的方法

```java
 /**
     * 关注
     * @param userId 用户id
     * @param entityType 实体类型
     * @param entityId 实体id
     */
    public void follow(int userId,int entityType,int entityId){
        redisTemplate.execute(new SessionCallback() {
            @Override
            public Object execute(RedisOperations operations) throws DataAccessException {
                String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);
                String followerKey = RedisKeyUtil.getFollowerKey(entityType, entityId);
                operations.multi();
                operations.opsForZSet().add(followeeKey,entityId,System.currentTimeMillis());
                operations.opsForZSet().add(followerKey,userId,System.currentTimeMillis());
                return operations.exec();
            }
        });
    }

    /**
     * 取关
     * @param userId 用户id
     * @param entityType 实体类型
     * @param entityId 实体id
     */
    public void unfollow(int userId,int entityType,int entityId){
        redisTemplate.execute(new SessionCallback() {
            @Override
            public Object execute(RedisOperations operations) throws DataAccessException {
                String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);
                String followerKey = RedisKeyUtil.getFollowerKey(entityType, entityId);
                operations.multi();
                operations.opsForZSet().remove(followeeKey,entityId);
                operations.opsForZSet().remove(followerKey,userId);
                return operations.exec();
            }
        });
    }
 /**
     * 查询关注的实体的数量
     * @param userId 用户id
     * @param entityType 用户类型
     * @return long
     */
    public long findFolloweeCount(int userId,int entityType){
        String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);
        return redisTemplate.opsForZSet().zCard(followeeKey);
    }

    /**
     * 查询实体的粉丝的数量
     * @param entityType 实体类型
     * @param entityId 实体id
     * @return long
     */
    public long findFollowerCount(int entityType,int entityId){
        String followerKey = RedisKeyUtil.getFollowerKey(entityType,entityId);
        return redisTemplate.opsForZSet().zCard(followerKey);
    }

    /**
     * 查询当前用户是否已关注该实体
     * @param userId
     * @param entityType
     * @param entityId
     * @return
     */
    public boolean hasFollowed(int userId,int entityType,int entityId){
        String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);
        return redisTemplate.opsForZSet().score(followeeKey,entityId)!=null;
    }
```

****

### 编写Controller

> 新增```FollowController```

```java
    /**
     * 关注
     * @param entityType 实体类型
     * @param entityId 实体id
     * @return JSON
     */
    @RequestMapping(path = "/follow",method = RequestMethod.POST)
    @ResponseBody
    public String follow(int entityType,int entityId){
        User user = hostHolder.getUser();
        followService.follow(user.getId(),entityType,entityId);
        
        return CommunityUtil.getJSONString(0,"已关注"); 
    }

    /**
     * 取关
     * @param entityType 实体类型
     * @param entityId 实体id
     * @return JSON
     */
    @RequestMapping(path = "/follow",method = RequestMethod.POST)
    @ResponseBody
    public String unfollow(int entityType,int entityId){
        User user = hostHolder.getUser();
        followService.unfollow(user.getId(),entityType,entityId);
        return CommunityUtil.getJSONString(0,"已取消关注");
}


```

> 修改```UserController```

```java
  /*查询关注数量*/
        long followeeCount = flowService.findFolloweeCount(userId, ENTY_TYPE_USER);
        model.addAttribute("followeeCount",followeeCount);
        /*粉丝数量*/
        long followerCount = flowService.findFollowerCount(ENTY_TYPE_USER, userId);
        model.addAttribute("followerCount",followerCount);

        /*是否已关注*/
        boolean hasFollowed = false;
        if(hostHolder.getUser()!=null){
            hasFollowed = flowService.hasFollowed(hostHolder.getUser().getId(),ENTY_TYPE_USER,userId);
        }
        model.addAttribute("hasFollowed",hasFollowed);
```



****

### 前端页面处理

> ```profile.html```

```html
	<button type="button"
									th:class="|btn ${hasFollowed?'btn-secondary':'btn-info'} btn-sm float-right mr-5 follow-btn|"
									th:text="${hasFollowed?'已关注':'关注TA'}"
									th:if="${loginUser!=null && loginUser.id!=user.id}">关注TA
							</button>

//-------------------------------------------------
<span>关注了 <a class="text-primary" href="followee.html" th:text="${followeeCount}">5</a> 人</span>
							<span class="ml-4">关注者 <a class="text-primary" href="follower.html" th:text="${followerCount}">123</a> 人
							</span>
							<span class="ml-4">获得了 <i class="text-danger" th:text="${likeCount}">87</i> 个赞</span>
```

### 效果演示

![](https://images.waer.ltd/img/20220129213908.png)

****

## 关注、粉丝列表

> 业务层

- 查询某个用户关注的人，支持分页。
- 查询某个用户的粉丝，支持分页。

> 表现层

- 处理【查询关注的人】、【查询粉丝】请求。
- 编写【查询关注的人】、【查询粉丝】模板。

****

### 编写Service

> 在```FollowService```中新增如下方法。

```java
    /**
     * 查询某用户关注的人
     * @return List
     */
    public List<Map<String,Object>> findFollowees(int userId,int offset,int limit){
        String followeeKey = RedisKeyUtil.getFolloweeKey(userId,ENTY_TYPE_USER );
        Set <Integer>targetIds = redisTemplate.opsForZSet().reverseRange(followeeKey, offset, offset + limit - 1);
        if(targetIds==null){
            return null;
        }
        List<Map<String,Object>> list = new ArrayList<>();
        for(Integer targetId:targetIds){
           Map<String,Object> map = new HashMap<>();
           User user = userService.findUserById(targetId);
           map.put("user",user);
            Double score = redisTemplate.opsForZSet().score(followeeKey, targetId);
            map.put("followTime",new Date(score.longValue()));
            list.add(map);
        }
        return list;
    }

    /**
     * 查询某用户的粉丝
     * @param userId
     * @param offset
     * @param limit
     * @return List
     */
    public List<Map<String,Object>> findFollowers(int userId,int offset,int limit){
        String followerKey = RedisKeyUtil.getFollowerKey(ENTY_TYPE_USER,userId);
        Set<Integer>  targetIds = redisTemplate.opsForZSet().reverseRange(followerKey,offset,offset+limit-1);
        if(targetIds==null){
            return null;
        }
        List<Map<String,Object>> list = new ArrayList<>();
        for(Integer targetId:targetIds){
            Map<String,Object> map = new HashMap<>();
            User user = userService.findUserById(targetId);
            map.put("user",user);
            Double score = redisTemplate.opsForZSet().score(followerKey, targetId);
            map.put("followTime",new Date(score.longValue()));
            list.add(map);
        }
        return list;
    }
```

****

### 编写Controller

> 在```FolloweController```中添加如下方法。

```java
 /**
     * 获取关注列表
     * @param userId 用户id
     * @param page 分页信息
     * @param model model
     * @return String
     */
    @RequestMapping(path = "/followees/{userId}",method = RequestMethod.GET)
    public String getFollowees(@PathVariable("userId") int userId, Page page, Model model){
        User user = userService.findUserById(userId);
        if(user == null){
            throw new RuntimeException("该用户不存在！");
        }
        model.addAttribute("user",user);
        page.setLimit(5);
        page.setPath("/followees/"+userId);
        page.setRows((int)followService.findFolloweeCount(userId,ENTY_TYPE_USER));
        List<Map<String,Object>> userList = followService.findFollowees(userId,page.getOffset(),page.getLimit());
        if(userList!=null){
            for (Map<String,Object> map : userList){
                User u = (User)map.get("user");
                map.put("hasFollowed",hasFollowed(u.getId()));
            }
        }
        model.addAttribute("users",userList);
        return "/site/followee";
    }

    /**
     * 获取粉丝列表
     * @param userId 用户id
     * @param page 分页信息
     * @param model model
     * @return String
     */
    @RequestMapping(path = "/followers/{userId}",method = RequestMethod.GET)
    public String getFollowers(@PathVariable("userId") int userId, Page page, Model model){
        User user = userService.findUserById(userId);
        if(user == null){
            throw new RuntimeException("该用户不存在！");
        }
        model.addAttribute("user",user);
        page.setLimit(5);
        page.setPath("/followers/"+userId);
        page.setRows((int)followService.findFollowerCount(ENTY_TYPE_USER,userId));
        List<Map<String,Object>> userList = followService.findFollowers(userId,page.getOffset(),page.getLimit());
        if(userList!=null){
            for (Map<String,Object> map : userList){
                User u = (User)map.get("user");
                map.put("hasFollowed",hasFollowed(u.getId()));
            }
        }
        model.addAttribute("users",userList);
        return "/site/follower";
    }



    /**
     * 判断是否关注了某用户
     * @param userId 用户id
     * @return bool
     */
    private boolean hasFollowed(int userId){
        if(hostHolder.getUser()==null){
            return false;
        }
        return followService.hasFollowed(hostHolder.getUser().getId(),ENTY_TYPE_USER,userId);
    }
```

****

### 处理前端页面

- profile.html

```html
<span>关注了 <a class="text-primary" th:href="@{|/followees/${user.id}|}" 
```

```html
<span class="ml-4">关注者 <a class="text-primary" th:href="@{|/followers/${user.id}|}" 
```

- followee.html

> 处理资源路径。



> 处理关注链接

```html
	<div class="main">
			<div class="container">
				<div class="position-relative">
					<!-- 选项 -->
					<ul class="nav nav-tabs mb-3">
						<li class="nav-item">
							<a class="nav-link position-relative active" th:href="@{|/followees/${user.id}|}"><i 
									class="text-info" th:text="${user.username}">
								Nowcoder</i> 关注的人</a>
						</li>
						<li class="nav-item">
							<a class="nav-link position-relative" th:href="@{|/followers/${user.id}|}">关注 <i 
									class="text-info" th:text="${user.username}">Nowcoder</i> 的人</a>
						</li>
					</ul>
					<a th:href="@{|/user/profile/${user.id}|}" class="text-muted position-absolute rt-0">返回个人主页&gt;</a>
				</div>
```

> 处理关注列表

```html
<li class="media pb-3 pt-3 mb-3 border-bottom position-relative" th:each="map:${users}">
						<a th:href="@{|/user/profile/${map.user.id}|}">
							<img th:src="${map.user.headerUrl}"
								 class="mr-4 rounded-circle user-header" alt="用户头像" >
						</a>
						<div class="media-body">
							<h6 class="mt-0 mb-3">
								<span class="text-success" th:utext="${map.user.username}">落基山脉下的闲人</span>
								<span class="float-right text-muted font-size-12">
									关注于 <i th:text="${#dates.format(map.followTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-28
									14:13:25</i>
								</span>
							</h6>
							<div>
								<input type="hidden" id="entityId" th:value="${map.user.id}">
								<button type="button"
										th:class="|btn ${map.hasFollowed?'btn-secondary':'btn-info'} btn-sm float-right mr-5 follow-btn|"
										th:text="${map.hasFollowed?'已关注':'关注TA'}"
										th:if="${loginUser!=null && loginUser.id!=user.id!=map.user.id}">
								>关注TA
								</button>
							</div>
						</div>
					</li>
```

> 复用index写好的分页模板。

- follower.html

> 和上一个页面类似，不再贴代码。

### 效果演示

![](https://images.waer.ltd/img/flist.gif)

****
